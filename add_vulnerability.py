#!/usr/bin/env python3
"""Calculate and add missing vulnerability and dealer data based on board number"""

import json

def get_vulnerability_from_board(board_num):
    """
    Calculate vulnerability based on board number (1-indexed)
    Bridge vulnerability cycle repeats every 16 boards
    """
    if board_num is None:
        return None
    
    # Convert to 0-indexed for calculation
    board_cycle = (board_num - 1) % 16
    
    vuln_cycle = [
        'None',   # Board 1
        'NS',     # Board 2
        'EW',     # Board 3
        'Both',   # Board 4
        'None',   # Board 5
        'NS',     # Board 6
        'EW',     # Board 7
        'Both',   # Board 8
        'None',   # Board 9
        'NS',     # Board 10
        'EW',     # Board 11
        'Both',   # Board 12
        'None',   # Board 13
        'NS',     # Board 14
        'EW',     # Board 15
        'Both',   # Board 16
    ]
    
    return vuln_cycle[board_cycle]

def get_dealer_from_board(board_num):
    """
    Calculate dealer based on board number
    Dealer rotates: N, E, S, W (repeats every 4 boards)
    """
    if board_num is None:
        return None
    
    dealers = ['N', 'E', 'S', 'W']
    dealer_idx = (board_num - 1) % 4
    return dealers[dealer_idx]

# Load database
with open('hands_database.json', 'r', encoding='utf-8') as f:
    data = json.load(f)

# Fix vulnerability and dealer
fixed_vul = 0
fixed_dealer = 0

for hand in data:
    board = hand.get('board')
    
    # Fix vulnerability
    if not hand.get('vulnerability') or hand.get('vulnerability') == 'None':
        vul = get_vulnerability_from_board(board)
        if vul:
            hand['vulnerability'] = vul
            fixed_vul += 1
    
    # Fix dealer
    if not hand.get('dealer') or hand.get('dealer') == 'None':
        dealer = get_dealer_from_board(board)
        if dealer:
            hand['dealer'] = dealer
            fixed_dealer += 1

print(f"âœ… Fixed vulnerability: {fixed_vul} hands")
print(f"âœ… Fixed dealer: {fixed_dealer} hands")

# Save back
with open('hands_database.json', 'w', encoding='utf-8') as f:
    json.dump(data, f, indent=2, ensure_ascii=False)

print("âœ… Database saved successfully")

# Verify
new_hands = [h for h in data if h.get('date') == '23.01.2026']
print(f"\nðŸ“Š Verification - New hands (23.01.2026):")
if new_hands:
    for i in range(min(3, len(new_hands))):
        h = new_hands[i]
        print(f"  Board {h.get('board')}: dealer={h.get('dealer')}, vuln={h.get('vulnerability')}")
