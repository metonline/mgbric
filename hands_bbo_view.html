<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bridge Hands - BBO Viewer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a472a 0%, #0f2818 100%);
            color: #333;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: white;
            margin-bottom: 10px;
            font-size: 2rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .board-info {
            text-align: center;
            color: white;
            margin-bottom: 20px;
            font-size: 1.1rem;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
            align-items: center;
        }
        input, select, button {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            font-family: inherit;
        }
        button {
            background: #2d5a3d;
            color: white;
            cursor: pointer;
            border: none;
            font-weight: bold;
            transition: background 0.3s;
        }
        button:hover {
            background: #1f3f2a;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .viewer-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            min-height: 500px;
        }
        .bbo-frame {
            width: 100%;
            height: 600px;
            border: none;
            border-radius: 4px;
        }
        .info-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .info-card {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #1976d2;
            color: white;
        }
        .info-label {
            font-size: 0.85rem;
            color: #ddd;
            margin-bottom: 5px;
        }
        .info-value {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .nav-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .nav-buttons button {
            padding: 10px 20px;
            min-width: 100px;
        }
        .loading {
            text-align: center;
            color: white;
            font-size: 1.2rem;
            padding: 20px;
        }
        .error {
            background: #fee;
            color: #c00;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
            border-left: 4px solid #c00;
        }
        .search-group {
            display: flex;
            gap: 10px;
        }
        .stats {
            color: white;
            text-align: center;
            margin-top: 20px;
            font-size: 0.95rem;
        }
        @media (max-width: 768px) {
            .bbo-frame {
                height: 400px;
            }
            .info-panel {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>♠ Bridge Hands Viewer (BBO) ♠</h1>
        <div class="board-info">
            <span>Board <strong id="boardNum">-</strong> of <strong id="totalBoards">-</strong></span>
        </div>

        <div class="controls">
            <div class="search-group">
                <input type="number" id="boardSearch" placeholder="Jump to board..." min="1">
                <button onclick="jumpToBoard()">Jump</button>
            </div>
            <button onclick="previousBoard()" id="prevBtn">← Previous</button>
            <button onclick="nextBoard()" id="nextBtn">Next →</button>
            <button onclick="randomBoard()">Random</button>
            <button onclick="fetchRealDD()" style="background: #d9534f;">Fetch Real DD</button>
        </div>

        <div class="info-panel">
            <div class="info-card">
                <div class="info-label">Dealer</div>
                <div class="info-value" id="dealerInfo">-</div>
            </div>
            <div class="info-card">
                <div class="info-label">Vulnerability</div>
                <div class="info-value" id="vulnInfo">-</div>
            </div>
            <div class="info-card">
                <div class="info-label">Event</div>
                <div class="info-value" id="eventInfo" style="font-size: 0.95rem;">-</div>
            </div>
            <div class="info-card">
                <div class="info-label">Date</div>
                <div class="info-value" id="dateInfo">-</div>
            </div>
        </div>

        <div id="loading" class="loading" style="display:none;">Loading hands data...</div>
        <div id="error" class="error" style="display:none;"></div>

        <div class="viewer-container">
            <iframe id="bbFrame" class="bbo-frame"></iframe>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div class="viewer-container" style="min-height: auto; padding: 15px;">
                <h3 style="color: #2d5a3d; margin-bottom: 15px;">Double Dummy Tricks</h3>
                <table id="ddTable" style="width: 100%; border-collapse: collapse; font-size: 0.8rem;">
                    <thead>
                        <tr style="background: #2d5a3d; color: white;">
                            <th style="padding: 6px; border: 1px solid #ddd;">Contract</th>
                            <th style="padding: 6px; border: 1px solid #ddd;">N</th>
                            <th style="padding: 6px; border: 1px solid #ddd;">E</th>
                            <th style="padding: 6px; border: 1px solid #ddd;">S</th>
                            <th style="padding: 6px; border: 1px solid #ddd;">W</th>
                        </tr>
                    </thead>
                    <tbody id="ddBody">
                        <tr><td colspan="5" style="padding: 8px; text-align: center; color: #999;">No DD data</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="viewer-container" style="min-height: auto; padding: 15px;">
                <h3 style="color: #2d5a3d; margin-bottom: 15px;">Board Results</h3>
                <table id="resultsTable" style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                    <thead>
                        <tr style="background: #2d5a3d; color: white;">
                            <th style="padding: 8px; border: 1px solid #ddd;">Pair</th>
                            <th style="padding: 8px; border: 1px solid #ddd;">Direction</th>
                            <th style="padding: 8px; border: 1px solid #ddd;">Result</th>
                            <th style="padding: 8px; border: 1px solid #ddd;">Score</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                        <tr><td colspan="4" style="padding: 8px; text-align: center; color: #999;">No results available</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="nav-buttons">
            <button onclick="previousBoard()" id="prevBtn2">← Previous Board</button>
            <button onclick="nextBoard()" id="nextBtn2">Next Board →</button>
            <button onclick="randomBoard()">Random Board</button>
        </div>

        <div class="stats" id="stats"></div>
    </div>

    <script>
        let allHands = [];
        let boardResults = {};
        let currentIndex = 0;

        async function loadHands() {
            document.getElementById('loading').style.display = 'block';
            try {
                const response = await fetch('/api/hands');
                if (!response.ok) throw new Error('Failed to load hands');
                const handsObj = await response.json();
                allHands = Object.entries(handsObj).map(([id, hand]) => ({ id, ...hand }));
                
                // Try to load results for each board
                await loadBoardResults();
                
                document.getElementById('totalBoards').textContent = allHands.length;
                displayBoard(0);
                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                document.getElementById('error').textContent = 'Error: ' + error.message;
                document.getElementById('error').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function loadBoardResults() {
            // Try to load results for each board from separate files
            for (let hand of allHands) {
                try {
                    const filename = `board${hand.id}_results.json`;
                    const response = await fetch(`/${filename}`);
                    if (response.ok) {
                        boardResults[hand.id] = await response.json();
                    }
                } catch (e) {
                    // Silently skip if no results file
                }
            }
        }

        function generateLIN(hand) {
            const dealerMap = {'N':1,'E':2,'S':3,'W':4};
            const vulnMap = {'None':0,'NS':1,'EW':2,'Both':3};
            const dealer = dealerMap[hand.dealer] || 1;
            const vuln = vulnMap[hand.vulnerability] || 0;
            return `qx|o1|md|${dealer}${hand.N},${hand.E},${hand.S}|rh||ah|Board ${hand.id}|sv|${vuln}|pg||`;
        }

        function displayBoard(index) {
            if (index < 0 || index >= allHands.length) return;
            
            currentIndex = index;
            const hand = allHands[index];
            const lin = generateLIN(hand);
            const encoded = encodeURIComponent(lin);
            
            // Update BBO frame
            document.getElementById('bbFrame').src = `https://www.bridgebase.com/tools/handviewer.html?lin=${encoded}`;
            
            // Update info
            document.getElementById('boardNum').textContent = hand.id;
            document.getElementById('dealerInfo').textContent = hand.dealer || '-';
            document.getElementById('vulnInfo').textContent = hand.vulnerability || '-';
            document.getElementById('eventInfo').textContent = hand.event_id || '-';
            document.getElementById('dateInfo').textContent = hand.date || '-';
            
            // Update DD table
            const ddBody = document.getElementById('ddBody');
            if (hand.dd_analysis) {
                const dd = hand.dd_analysis;
                const suits = ['NT', 'S', 'H', 'D', 'C'];
                ddBody.innerHTML = suits.map(suit => `
                    <tr style="background: ${suits.indexOf(suit) % 2 === 0 ? 'white' : '#f9f9f9'};">
                        <td style="padding: 6px; border: 1px solid #ddd; font-weight: bold;">${suit}</td>
                        <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${dd[suit + 'N'] || '-'}</td>
                        <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${dd[suit + 'E'] || '-'}</td>
                        <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${dd[suit + 'S'] || '-'}</td>
                        <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${dd[suit + 'W'] || '-'}</td>
                    </tr>
                `).join('');
            } else {
                ddBody.innerHTML = '<tr><td colspan="5" style="padding: 8px; text-align: center; color: #999;">No DD data</td></tr>';
            }
            
            const results = boardResults[hand.id];
            if (results && results.length > 0) {
                resultsBody.innerHTML = results.map(result => `
                    <tr style="background: ${results.indexOf(result) % 2 === 0 ? 'white' : '#f9f9f9'};">
                        <td style="padding: 8px; border: 1px solid #ddd; font-size: 0.8rem;">${result.pair_names || result.pair_num}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${result.direction || '-'}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; color: #d9534f;">${result.result || '-'}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${result.score ? result.score.toFixed(2) : '-'}</td>
                    </tr>
                `).join('');
            } else {
                resultsBody.innerHTML = '<tr><td colspan="4" style="padding: 8px; text-align: center; color: #999;">No results available</td></tr>';
            }
            
            // Update button states
            document.getElementById('prevBtn').disabled = index === 0;
            document.getElementById('prevBtn2').disabled = index === 0;
            document.getElementById('nextBtn').disabled = index === allHands.length - 1;
            document.getElementById('nextBtn2').disabled = index === allHands.length - 1;
            
            // Update stats
            document.getElementById('stats').textContent = `Viewing board ${index + 1}/${allHands.length} • Event: ${hand.tournament || hand.event_id || 'Unknown'}`;
            
            window.scrollTo(0, 0);
        }

        function nextBoard() {
            if (currentIndex < allHands.length - 1) {
                displayBoard(currentIndex + 1);
            }
        }

        function previousBoard() {
            if (currentIndex > 0) {
                displayBoard(currentIndex - 1);
            }
        }

        function randomBoard() {
            const randomIndex = Math.floor(Math.random() * allHands.length);
            displayBoard(randomIndex);
        }

        function jumpToBoard() {
            const boardId = document.getElementById('boardSearch').value.trim();
            if (!boardId) return;
            
            const foundIndex = allHands.findIndex(hand => hand.id === boardId);
            if (foundIndex !== -1) {
                displayBoard(foundIndex);
                document.getElementById('boardSearch').value = '';
            } else {
                alert('Board not found');
            }
        }

        document.getElementById('boardSearch').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') jumpToBoard();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowRight') nextBoard();
            if (e.key === 'ArrowLeft') previousBoard();
        });

        function fetchRealDD() {
            const boardId = allHands[currentIndex].id;
            const hand = allHands[currentIndex];
            
            if (!confirm(`Fetch real DD solution for Board ${boardId} from DDS solver?\n\nThis will open the DDS solver in a new window.\n\nAfter solving, manually update hands_database.json with results.`)) {
                return;
            }
            
            // Generate LIN format
            const dealerMap = {'N':1,'E':2,'S':3,'W':4};
            const vulnMap = {'None':0,'NS':1,'EW':2,'Both':3};
            const dealer = dealerMap[hand.dealer] || 1;
            const vuln = vulnMap[hand.vulnerability] || 0;
            const lin = `qx|o1|md|${dealer}${hand.N},${hand.E},${hand.S}|rh||ah|Board ${boardId}|sv|${vuln}|pg||`;
            
            // Open DDS solver with this hand
            const solverUrl = `https://dds.bridgewebs.com/bsol_standalone/ddummy.html?lin=${encodeURIComponent(lin)}`;
            window.open(solverUrl, 'dds_solver', 'width=1000,height=800');
        }

        loadHands();
    </script>
</body>
</html>
