#!/usr/bin/env python3
"""Fix vulnerability data based on board numbers (standard bridge duplicate pattern)"""

import json

def get_vulnerability_by_board(board_num):
    """
    Calculate vulnerability based on board number (standard duplicate bridge)
    Pattern repeats every 16 boards:
    1,8,15,22,29: None
    2,9,16,23,30: NS
    3,10,17,24: EW
    4,11,18,25: Both
    5,12,19,26: None
    6,13,20,27: EW
    7,14,21,28: Both
    """
    
    # Modern 8-board vulnerability cycle (more common):
    # Boards 1,8,15,22,29: None
    # Boards 2,9,16,23,30: NS
    # Boards 3,10,17,24: EW
    # Boards 4,11,18,25: Both
    # Boards 5,12,19,26: None
    # Boards 6,13,20,27: EW
    # Boards 7,14,21,28: Both
    
    vuln_map = {
        1: 'None',  2: 'NS', 3: 'EW', 4: 'Both',
        5: 'None',  6: 'EW', 7: 'Both', 8: 'None',
        9: 'NS',    10: 'EW', 11: 'Both', 12: 'None',
        13: 'EW',   14: 'Both', 15: 'None', 16: 'NS',
        17: 'EW',   18: 'Both', 19: 'None', 20: 'NS',
        21: 'Both', 22: 'None', 23: 'NS', 24: 'EW',
        25: 'Both', 26: 'None', 27: 'EW', 28: 'Both',
        29: 'None', 30: 'NS'
    }
    
    return vuln_map.get(board_num, 'None')

def main():
    print("="*70)
    print("Fixing vulnerability data in hands_database")
    print("="*70)
    
    with open('hands_database.json', 'r', encoding='utf-8') as f:
        hands = json.load(f)
    
    print(f"\nProcessing {len(hands)} hands...\n")
    
    # Calculate vulnerability for each hand
    vuln_counts = {}
    for hand in hands:
        board_num = hand.get('board', 1)
        vuln = get_vulnerability_by_board(board_num)
        hand['vulnerability'] = vuln
        
        vuln_counts[vuln] = vuln_counts.get(vuln, 0) + 1
    
    # Save updated database
    with open('hands_database.json', 'w', encoding='utf-8') as f:
        json.dump(hands, f, indent=2, ensure_ascii=False)
    
    print("Vulnerability distribution after fix:")
    for vuln in ['None', 'NS', 'EW', 'Both']:
        count = vuln_counts.get(vuln, 0)
        print(f"  {vuln:4s}: {count:3d} hands")
    
    total = sum(vuln_counts.values())
    print(f"\nTotal: {total} hands")
    print("="*70)
    print("âœ“ Vulnerability data fixed!")
    
    # Show sample
    print("\nSample hands:")
    from collections import defaultdict
    by_date = defaultdict(list)
    for h in hands:
        by_date[h.get('date')].append(h)
    
    for date in sorted(by_date.keys())[:5]:
        sample = by_date[date][0]
        print(f"  {date}: Event {sample['event_id']} Board {sample['board']} - Vuln: {sample['vulnerability']}")

if __name__ == '__main__':
    main()
