<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bridge Tournament Hands - Organized by Tournament</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: Arial, sans-serif;
            background: #f0f0f0;
            color: #333;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2rem;
            color: #222;
        }
        
        .header-info {
            text-align: center;
            margin-bottom: 20px;
            font-size: 0.95rem;
            color: #666;
        }
        
        .tournament-section {
            margin-bottom: 30px;
            background: white;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .tournament-header {
            background: #333;
            color: white;
            padding: 15px 20px;
            font-size: 1.2rem;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .tournament-stats {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .boards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(500px, 1fr));
            gap: 15px;
            padding: 15px;
        }
        
        .board-card {
            background: white;
            border: 1px solid #ddd;
            padding: 12px;
            page-break-inside: avoid;
            display: flex;
            flex-direction: column;
        }
        
        .board-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #ccc;
            font-weight: bold;
            gap: 10px;
        }
        
        .vuln-indicator {
            width: 50px;
            height: 50px;
            border: 2px solid #333;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto 1fr auto;
            gap: 0;
            font-weight: bold;
            font-size: 0.7rem;
            text-align: center;
            line-height: 1;
        }
        
        .vuln-quad {
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #333;
            padding: 2px;
        }
        
        .vuln-quad-n { grid-column: 1 / 3; }
        .vuln-quad-e { grid-row: 2; grid-column: 2; }
        .vuln-quad-s { grid-column: 1 / 3; }
        .vuln-quad-w { grid-row: 2; grid-column: 1; }
        .vuln-quad-dealer { grid-row: 2; grid-column: 1 / 3; font-size: 0.85rem; }
        
        .vuln-red { background: #e74c3c; color: white; }
        .vuln-white { background: white; color: #333; }
        
        .board-header-center {
            flex: 1;
            text-align: center;
            font-size: 1.1rem;
        }
        
        .board-header-right {
            flex: 1;
            text-align: center;
            font-size: 0.9rem;
        }
        
        .board-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            flex: 1;
        }
        
        .bbo-viewer {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
        }
        
        .bbo-viewer.vuln-none { background: #e8f5e9; border: 2px solid #4caf50; }
        .bbo-viewer.vuln-ns { background: #fff3e0; border: 2px solid #ff9800; }
        .bbo-viewer.vuln-ew { background: #e3f2fd; border: 2px solid #2196f3; }
        .bbo-viewer.vuln-both { background: #fce4ec; border: 2px solid #e91e63; }
        
        .bbo-frame {
            width: 100%;
            height: auto;
            aspect-ratio: 4 / 3;
            border: 1px solid #999;
        }
        
        .dd-table-simple {
            width: 100%;
            border: 1px solid #333;
            display: flex;
            justify-content: center;
            padding: 4px;
        }
        
        .dd-table-simple table {
            border-collapse: collapse;
            font-family: Arial, sans-serif;
            width: auto;
        }
        
        .dd-table-simple th, .dd-table-simple td {
            border: 1px solid #333;
            padding: 5px 7px;
            text-align: center;
            font-size: 0.85rem;
            font-weight: bold;
            min-width: 32px;
        }
        
        .dd-table-simple th {
            background: white;
        }
        
        .suit-C { color: #000; }
        .suit-D { color: #d00; }
        .suit-H { color: #d00; }
        .suit-S { color: #000; }
        .suit-NT { color: #000; }
        
        .making { background: #c8e6c9 !important; }
        
        .stats { text-align: center; padding: 20px; font-size: 0.9rem; color: #666; }
        
        @media (max-width: 1280px) {
            .boards-grid { grid-template-columns: repeat(auto-fill, minmax(450px, 1fr)); }
        }
        
        @media (max-width: 768px) {
            .boards-grid { grid-template-columns: 1fr; }
            .tournament-header { flex-direction: column; gap: 8px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŒ‰ Bridge Tournament Hands</h1>
        <div class="header-info" id="header-info">Loading...</div>
        <div id="tournaments-container"></div>
        <div class="stats" id="stats">Loading statistics...</div>
    </div>

    <script>
        let allHands = {};
        let tournamentsData = {};
        
        function getVulnColor(player, vuln) {
            if (!vuln) return 'vuln-white';
            const v = vuln.toLowerCase().trim();
            
            if (v === 'both' || v === 'all') return 'vuln-red';
            if (v === 'none' || v === '-') return 'vuln-white';
            
            if (v === 'ns' || v === 'n-s') {
                return (player === 'N' || player === 'S') ? 'vuln-red' : 'vuln-white';
            }
            
            if (v === 'ew' || v === 'e-w') {
                return (player === 'E' || player === 'W') ? 'vuln-red' : 'vuln-white';
            }
            
            return 'vuln-white';
        }
        
        function getVulnClass(vuln) {
            if (!vuln) return 'vuln-none';
            const v = vuln.toLowerCase().trim();
            if (v === 'none' || v === '-') return 'vuln-none';
            if (v === 'ns' || v === 'n-s') return 'vuln-ns';
            if (v === 'ew' || v === 'e-w') return 'vuln-ew';
            if (v === 'both' || v === 'all') return 'vuln-both';
            return 'vuln-none';
        }
        
        function generateLIN(hand) {
            const suits = { N: 'S', E: 'H', S: 'D', W: 'C' };
            const suits_bbo = { N: 's', E: 'h', S: 'd', W: 'c' };
            
            let lin = 'qx|o1|md|';
            
            for (const player of ['N', 'E', 'S', 'W']) {
                const hand_str = hand[player] || '';
                let hand_bbo = '';
                
                for (let i = 0; i < hand_str.length; i += 3) {
                    const suit = hand_str[i];
                    const cards = hand_str.substring(i+1, i+3);
                    const suit_lower = suits_bbo[suits[player]] || suit.toLowerCase();
                    hand_bbo += suit_lower + cards.toLowerCase();
                }
                
                if (player !== 'N') lin += ',';
                lin += hand_bbo;
            }
            
            lin += '|sv|' + (hand.vulnerability ? hand.vulnerability.toUpperCase() : 'None');
            lin += '|md||pg||';
            
            return lin;
        }
        
        function createDDTable(hand) {
            if (!hand.dd_analysis) {
                return '<div style="text-align:center;color:#999;padding:10px;">No DD data</div>';
            }

            const dd = hand.dd_analysis;
            const players = ['N', 'S', 'E', 'W'];
            const suits = [
                { symbol: 'â™£', key: 'C' },
                { symbol: 'â™¦', key: 'D' },
                { symbol: 'â™¥', key: 'H' },
                { symbol: 'â™ ', key: 'S' },
                { symbol: 'NT', key: 'NT' }
            ];

            let html = '<table>';
            
            // Header
            html += '<tr>';
            html += '<th style="width: 25px;"></th>';
            suits.forEach(suit => {
                html += `<th class="suit-${suit.key}">${suit.symbol}</th>`;
            });
            html += '</tr>';
            
            // Rows
            players.forEach(player => {
                html += '<tr>';
                html += `<td style="font-weight: bold; text-align: center; width: 25px;">${player}</td>`;
                
                suits.forEach(suit => {
                    const key = suit.key + player;
                    const value = dd[key] || '-';
                    const isMaking = parseInt(value) >= 10;
                    const bgColor = (isMaking && value !== '-') ? '#c8e6c9' : 'white';
                    html += `<td style="background:${bgColor};">${value}</td>`;
                });
                
                html += '</tr>';
            });
            
            html += '</table>';
            return html;
        }
        
        async function loadHands() {
            try {
                const response = await fetch('/api/hands');
                if (!response.ok) throw new Error('Failed to load hands');
                allHands = await response.json();
                
                // Organize by tournament
                tournamentsData = {};
                for (const [id, hand] of Object.entries(allHands)) {
                    const tourney = hand.tournament || 'Unknown Tournament';
                    if (!tournamentsData[tourney]) {
                        tournamentsData[tourney] = [];
                    }
                    tournamentsData[tourney].push({...hand, id});
                }
                
                renderTournaments();
                updateStats();
            } catch (e) {
                console.error('Error loading hands:', e);
                document.getElementById('tournaments-container').innerHTML = `<div style="color: red; padding: 20px;">Error loading hands: ${e.message}</div>`;
            }
        }
        
        function renderTournaments() {
            const container = document.getElementById('tournaments-container');
            container.innerHTML = '';
            
            const tournaments = Object.entries(tournamentsData).sort((a, b) => {
                const dateA = extractDate(a[0]);
                const dateB = extractDate(b[0]);
                return dateB - dateA;
            });
            
            tournaments.forEach(([tourney, hands]) => {
                const section = document.createElement('div');
                section.className = 'tournament-section';
                
                const header = document.createElement('div');
                header.className = 'tournament-header';
                header.innerHTML = `
                    <span>${tourney}</span>
                    <span class="tournament-stats">${hands.length} boards</span>
                `;
                section.appendChild(header);
                
                const grid = document.createElement('div');
                grid.className = 'boards-grid';
                
                hands.sort((a, b) => {
                    const boardA = parseInt(a.id) || 0;
                    const boardB = parseInt(b.id) || 0;
                    return boardA - boardB;
                }).forEach(hand => {
                    const card = document.createElement('div');
                    card.className = 'board-card';
                    
                    const lin = generateLIN(hand);
                    const encoded = encodeURIComponent(lin);
                    
                    let html = `
                        <div class="board-header">
                            <div class="board-header-left">
                                <div class="vuln-indicator">
                                    <div class="vuln-quad vuln-quad-n ${getVulnColor('N', hand.vulnerability)}">N</div>
                                    <div class="vuln-quad vuln-quad-e ${getVulnColor('E', hand.vulnerability)}">E</div>
                                    <div class="vuln-quad vuln-quad-dealer">${hand.dealer || '-'}</div>
                                    <div class="vuln-quad vuln-quad-w ${getVulnColor('W', hand.vulnerability)}">W</div>
                                    <div class="vuln-quad vuln-quad-s ${getVulnColor('S', hand.vulnerability)}">S</div>
                                </div>
                            </div>
                            <div class="board-header-center">Board ${hand.id}</div>
                            <div class="board-header-right">Vuln: ${hand.vulnerability || '-'}</div>
                        </div>
                        <div class="board-content">
                            <div class="bbo-viewer ${getVulnClass(hand.vulnerability)}">
                                <iframe class="bbo-frame" src="https://www.bridgebase.com/tools/handviewer.html?lin=${encoded}"></iframe>
                            </div>
                            <div class="dd-table-simple">
                                ${createDDTable(hand)}
                            </div>
                        </div>
                    `;
                    
                    card.innerHTML = html;
                    grid.appendChild(card);
                });
                
                section.appendChild(grid);
                container.appendChild(section);
            });
        }
        
        function extractDate(toureyName) {
            const match = toureyName.match(/(\d{2})-(\d{2})-(\d{4})/);
            if (match) {
                return new Date(match[3], match[2]-1, match[1]);
            }
            return new Date(0);
        }
        
        function updateStats() {
            const totalHands = Object.keys(allHands).length;
            const totalTournaments = Object.keys(tournamentsData).length;
            const fetchDate = new Date().toLocaleString();
            
            document.getElementById('header-info').textContent = `${totalTournaments} tournaments | ${totalHands} boards | Updated: ${fetchDate}`;
            document.getElementById('stats').textContent = `Total: ${totalHands} boards across ${totalTournaments} tournaments`;
        }
        
        // Load on page load
        loadHands();
    </script>
</body>
</html>
