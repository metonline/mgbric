<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="description" content="Ho≈üg√∂r√º Bri√ß Kul√ºb√º - Board Bazƒ±nda Sƒ±ralama">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%231e3c72' width='192' height='192'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='80' fill='white' font-weight='bold'>üé¥</text></svg>">
    <title>Board Bazƒ±nda Kul√ºp Sƒ±ralamasƒ±</title>
    <link rel="stylesheet" href="mobile.css">
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: #00d9ff;
            margin-bottom: 10px;
            font-size: 1.8em;
        }
        
        .tournament-info {
            text-align: center;
            color: #aaa;
            margin-bottom: 20px;
            font-size: 0.95em;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .control-group label {
            font-size: 0.85em;
            color: #aaa;
        }
        
        .control-group input, .control-group select {
            padding: 10px 15px;
            border: 1px solid #444;
            border-radius: 6px;
            background: #2a2a4a;
            color: #fff;
            font-size: 1em;
            min-width: 120px;
        }
        
        .control-group input:focus, .control-group select:focus {
            outline: none;
            border-color: #00d9ff;
        }
        
        .btn {
            padding: 10px 25px;
            background: linear-gradient(135deg, #00d9ff, #0099cc);
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            align-self: flex-end;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,217,255,0.3);
        }
        
        .btn:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .board-nav {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .board-nav button {
            padding: 8px 15px;
            background: #2a2a4a;
            color: #fff;
            border: 1px solid #444;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .board-nav button:hover {
            background: #3a3a5a;
            border-color: #00d9ff;
        }
        
        .board-nav button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .board-number {
            background: #00d9ff;
            color: #000;
            padding: 8px 20px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #00d9ff;
        }
        
        .loading::after {
            content: '';
            animation: dots 1.5s infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        .error {
            text-align: center;
            padding: 20px;
            color: #ff6b6b;
            background: rgba(255,107,107,0.1);
            border-radius: 8px;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            background: #ffffff;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .results-table th {
            background: #1e3c72;
            padding: 10px 6px;
            text-align: center;
            font-weight: 600;
            color: #fff;
            font-size: 0.85em;
            border-bottom: 2px solid #2a5298;
        }
        
        .results-table td {
            padding: 8px 5px;
            border-bottom: 1px solid #eee;
            color: #000;
            font-size: 0.85em;
            text-align: center;
        }
        
        .results-table tr:hover {
            background: #f5f5f5;
        }
        
        .hand-diagram {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none;
        }
        
        .hand-diagram.show {
            display: block;
        }
        
        .hand-diagram h3 {
            color: #1e3c72;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .hand-table {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            border-collapse: collapse;
        }
        
        .hand-table td {
            padding: 12px;
            text-align: center;
            font-size: 13px;
            font-family: 'Courier New', monospace;
            border: 1px solid #ddd;
        }
        
        .hand-north, .hand-south {
            background: #e8f4ff;
            color: #1e3c72;
            font-weight: bold;
        }
        
        .hand-east, .hand-west {
            background: #ffe8f4;
            color: #1e3c72;
            font-weight: bold;
        }
        
        .compass-center {
            background: #f0f0f0;
            font-weight: bold;
            color: #333;
            line-height: 1.6;
        }
        
        .results-table tr.ns-row {
            background: #ffffff;
        }
        
        .results-table tr.ew-row {
            background: #ffffff;
        }
        
        .rank-cell {
            font-weight: bold;
            text-align: center;
            width: 50px;
            color: #333;
        }
        
        .rank-1 { color: #d4af37; font-size: 1.2em; }
        .rank-2 { color: #808080; font-size: 1.1em; }
        .rank-3 { color: #cd7f32; font-size: 1.05em; }
        
        .player-cell {
            font-weight: 500;
            color: #000;
            text-align: left;
            white-space: normal;
            word-wrap: break-word;
            max-width: 180px;
            line-height: 1.3;
        }
        
        .direction-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .direction-ns {
            background: #2196F3;
            color: white;
        }
        
        .direction-ew {
            background: #FF9800;
            color: white;
        }
        
        .contract-cell {
            font-weight: bold;
            white-space: nowrap;
            color: #000;
        }
        
        .suit-red { color: #cb0000; }
        .suit-black { color: #000; }
        
        /* ===== BBO STYLE HAND DIAGRAM ===== */
        .hand-diagram-container {
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
        }
        
        .mainDivStyle {
            position: relative;
            width: 500px;
            height: 475px;
            background: #c0c1c0;
            border-radius: 4px;
            overflow: visible;
        }
        
        .handDivStyle {
            position: absolute;
            background: #cbcbcb;
            width: 160px;
            height: 124px;
            font-size: 22px;
        }
        
        .suitRowDivStyle {
            position: relative;
            height: 25px;
            line-height: 25px;
            white-space: nowrap;
            padding-left: 5px;
        }
        
        .suitSymbol {
            display: inline-block;
            width: 30px;
            font-size: 30px;
            text-align: center;
            vertical-align: middle;
        }
        
        .suitHolding {
            display: inline-block;
            font-size: 22px;
            letter-spacing: 2px;
            vertical-align: middle;
            color: #000;
        }
        
        .nameRowDivStyle {
            position: absolute;
            height: 30px;
            line-height: 30px;
            border: 1px solid white;
            white-space: nowrap;
            font-size: 18px;
            font-weight: bold;
            background: white;
        }
        
        .nameInitial {
            display: inline-block;
            width: 30px;
            text-align: center;
            font-weight: bold;
            color: #000;
            font-size: 16px;
        }
        
        .vulInnerDivStyle {
            position: absolute;
            background: white;
            border: 3px solid #880000;
            font-size: 42px;
            font-weight: bold;
            text-align: center;
            width: 60px;
            height: 60px;
            line-height: 54px;
        }
        
        .dealer-bg { background: #ffce00 !important; color: black !important; }
        
        /* Position Classes */
        .pos-n-name { left: 170px; top: 5px; width: 160px; }
        .pos-n-hand { left: 170px; top: 35px; }
        .pos-w-name { left: 5px; top: 160px; width: 160px; }
        .pos-w-hand { left: 5px; top: 190px; }
        .pos-e-name { left: 335px; top: 160px; width: 160px; }
        .pos-e-hand { left: 335px; top: 190px; }
        .pos-s-name { left: 170px; top: 315px; width: 160px; }
        .pos-s-hand { left: 170px; top: 345px; }
        .pos-board { 
            left: 220px; 
            top: 215px;
            width: 60px;
            height: 60px;
            background: white;
            border: 2px solid #808080;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        /* Board Info - Left Side */
        .board-info-left {
            position: absolute;
            left: 8px;
            top: 8px;
            font-size: 15px;
            color: #333;
            line-height: 1.6;
            text-align: left;
        }
        
        .board-info-left .date {
            font-weight: bold;
        }
        
        .board-info-left .dealer {
            background: #ffce00;
            color: black;
            font-weight: bold;
            padding: 1px 4px;
            border-radius: 2px;
            display: block;
        }
        
        .board-info-left .vul {
            background: white;
            color: black;
            font-weight: bold;
            padding: 1px 4px;
            border-radius: 2px;
            display: block;
            margin-top: 2px;
        }
        
        .board-info-left .vul.vul-active {
            background: #cb0000;
            color: white;
        }
        
        /* HCP Display */
        .hcp-display {
            position: absolute;
            left: 335px;
            top: 35px;
            width: 160px;
            font-size: 16px;
            color: #333;
            text-align: center;
        }
        
        .hcp-display .hcp-north {
            text-align: center;
            font-weight: bold;
        }
        
        .hcp-display .hcp-south {
            text-align: center;
            font-weight: bold;
            margin-top: 10px;
        }
        
        .hcp-display .hcp-middle {
            display: flex;
            justify-content: space-between;
            padding: 8px 20px;
            margin-top: 5px;
        }
        
        .hcp-display .hcp-value {
            font-weight: bold;
            color: #000;
            font-size: 18px;
        }
        
        /* DD Table - BBO Style */
        .bhDoubleDummy {
            position: absolute;
            padding: 5px;
            border: 0px solid #808080;
            background: #c0c1c0;
            font-size: 10px;
            width: 153px;
            left: 1px;
            bottom: 5px;
            color: #000;
            transform: scale(0.95);
            transform-origin: bottom left;
        }
        
        .bh-dd {
            text-align: center;
            border-collapse: collapse;
            margin-bottom: 5px;
            color: #000;
        }
        
        .bh-dd th, .bh-dd td {
            width: 26px;
            height: 21px;
            text-align: center;
            color: #000;
        }
        
        .bh-dd th {
            font-weight: bold;
            border: none;
            color: #000;
        }
        
        .bh-dd th:first-child {
            width: 20px;
        }
        
        .bh-dd td {
            border: 2px solid #444;
            background: #fff;
            color: #000;
        }
        
        .bh-dd td:first-child {
            border: none;
            font-weight: bold;
            background: transparent;
        }
        
        .bh-dd .suit-symbol {
            font-size: 16px;
        }
        
        .par-display {
            font-size: 12px;
            line-height: 1.4;
            color: #000;
        }
        
        .par-display strong {
            display: block;
        }
        
        /* Suit colors */
        .suit-black { color: #000 !important; }
        .suit-red { color: #cb0000 !important; }
        
        /* LoTT Display */
        .lottDisplay {
            position: absolute;
            padding: 8px;
            border: 1px solid #c0c1c0;
            background: #c0c1c0;
            color: #000;
            font-size: 15px;
            text-align: center;
            min-width: 100px;
            right: 25px;
            bottom: 25px;
            color: black;
        }
        
        .lott-title {
            font-weight: bold;
            color: black;
            margin-bottom: 3px;
            font-size: 1.125em;
        }
        
        .lott-value {
            font-size: 35px;
            font-weight: bold;
            color: black;
        }
        
        .lott-detail {
            font-size: 12.5px;
            color: black;
            margin-top: 3px;
        }
        /* ===== END BBO STYLE ===== */
        
        .score-cell {
            text-align: right;
            font-weight: 500;
            color: #000;
        }
        
        .percent-cell {
            text-align: right;
            font-weight: bold;
        }
        
        .percent-high { color: #2e7d32; }
        .percent-low { color: #c62828; }
        
        .summary {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        
        .summary-item {
            text-align: center;
        }
        
        .summary-label {
            font-size: 0.85em;
            color: #aaa;
        }
        
        .summary-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #00d9ff;
        }
        
        /* Mobile wrapper for scaling */
        .scale-wrapper {
            display: inline-block;
        }
        
        @media (max-width: 600px) {
            body {
                padding: 0;
                margin: 0;
            }
            
            .container {
                max-width: 100%;
                padding: 0;
                margin: 0;
            }
            
            h1 {
                font-size: 1em;
                margin-bottom: 2px;
                padding: 0 5px;
            }
            
            .header-container {
                margin-bottom: 3px;
                padding: 0;
            }
            
            .controls {
                display: none;
            }
            
            .board-nav {
                gap: 5px;
                margin-bottom: 5px;
            }
            
            .board-nav button {
                padding: 5px 10px;
                font-size: 0.85em;
            }
            
            .board-number {
                padding: 5px 12px;
                font-size: 0.95em;
            }
            
            /* Hand diagram - scale wrapper approach */
            .hand-diagram-container {
                display: flex;
                justify-content: center;
                overflow: visible;
                margin: 0;
                padding: 0;
            }
            
            .scale-wrapper {
                transform: scale(0.78);
                transform-origin: top center;
                margin-bottom: -105px;
            }
            
            /* Results Table */
            .results-table {
                font-size: 0.8em;
                margin-top: 15px;
            }
            
            .results-table th, .results-table td {
                padding: 5px 3px;
            }
            
            .results-table th:nth-child(2),
            .results-table td:nth-child(2) {
                max-width: 100px;
                white-space: normal;
                word-wrap: break-word;
                text-align: left;
            }
            
            .direction-badge {
                margin-left: 2px;
                padding: 1px 3px;
                font-size: 0.7em;
            }
        }
        
        @media (max-width: 420px) {
            .scale-wrapper {
                transform: scale(0.72);
                margin-bottom: -130px;
            }
        }
        
        @media (max-width: 380px) {
            h1 { font-size: 0.9em; }
            
            .scale-wrapper {
                transform: scale(0.66);
                margin-bottom: -160px;
            }
            
            .results-table { font-size: 0.75em; }
        }
        
        @media (max-width: 340px) {
            .scale-wrapper {
                transform: scale(0.60);
                margin-bottom: -188px;
            }
        }
        
        /* Safe area for notch phones */
        @supports (padding-top: env(safe-area-inset-top)) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
            }
        }
        
        .header-container {
            position: relative;
            margin-bottom: 15px;
        }
        
        .close-btn {
            position: absolute;
            right: 0;
            top: 0;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            font-size: 1.3em;
            cursor: pointer;
            padding: 8px 14px;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .close-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: #00d9ff;
            color: #00d9ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-container" id="headerContainer">
            <button class="close-btn" onclick="goBack()" title="Geri">‚úï</button>
            <h1 id="mainTitle">üé¥ Board Bazƒ±nda Kul√ºp Sƒ±ralamasƒ±</h1>
            <div class="tournament-info" id="tournamentInfo" style="display:none;"></div>
        </div>
        
        <!-- Hidden inputs for JS compatibility -->
        <input type="hidden" id="eventId" value="">
        <input type="hidden" id="boardNum" value="1">
        
        <!-- Advanced Filters -->
        <div class="controls" id="filterControls" style="display:none;">
            <div class="control-group">
                <label for="filterDate">Tarih:</label>
                <select id="filterDate">
                    <option value="">T√ºm Tarihler</option>
                </select>
            </div>
            <div class="control-group">
                <label for="filterEvent">Turnuva:</label>
                <select id="filterEvent">
                    <option value="">T√ºm Turnuvalar</option>
                </select>
            </div>
            <div class="control-group">
                <label for="filterBoard">Board:</label>
                <input type="number" id="filterBoard" min="1" max="30" placeholder="1-30">
            </div>
        </div>
        
        <div class="board-nav" id="boardNav" style="display: none;">
            <button onclick="changeBoard(-1)" id="prevBtn">‚óÄ √ñnceki</button>
            <span class="board-number" id="currentBoard">Board 1</span>
            <button onclick="changeBoard(1)" id="nextBtn">Sonraki ‚ñ∂</button>
        </div>
        
        <!-- Hand Diagram Display -->
        <div class="hand-diagram" id="handDiagram">
            <h3>Board <span id="diagramBoardNum"></span> - Hands</h3>
            <table class="hand-table">
                <tr>
                    <td colspan="3" class="hand-north" id="handN"></td>
                </tr>
                <tr>
                    <td class="hand-west" id="handW"></td>
                    <td class="compass-center">N<br>W E<br>S</td>
                    <td class="hand-east" id="handE"></td>
                </tr>
                <tr>
                    <td colspan="3" class="hand-south" id="handS"></td>
                </tr>
            </table>
        </div>
        
        <div id="content"></div>
    </div>
    
    <script>
        let currentEventId = '';
        let currentBoard = 1;
        let allEvents = {};
        let allHands = [];
        
        function goBack() {
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = 'hands_bbo_view.html';
            }
        }
        
        function formatSuitWithColor(text) {
            if (!text) return '';
            return text
                .replace(/‚ô†/g, '<span class="suit-black">‚ô†</span>')
                .replace(/‚ô£/g, '<span class="suit-black">‚ô£</span>')
                .replace(/‚ô•/g, '<span class="suit-red">‚ô•</span>')
                .replace(/‚ô¶/g, '<span class="suit-red">‚ô¶</span>');
        }
        
        function formatContract(contract) {
            if (!contract) return '-';
            
            // Clean up the contract string
            // Handle cases where suit symbols appear in wrong position like "‚ô•4‚ô•X‚ô•"
            // Extract level (1-7), suit, and modifiers (X, XX, +, -, etc)
            
            let cleaned = contract;
            
            // Remove duplicate suit symbols - keep only first occurrence
            const suitSymbols = ['‚ô†', '‚ô•', '‚ô¶', '‚ô£'];
            for (const suit of suitSymbols) {
                const count = (cleaned.match(new RegExp(suit, 'g')) || []).length;
                if (count > 1) {
                    // Remove all suit symbols and reconstruct
                    const level = cleaned.match(/[1-7]/)?.[0];
                    const modifiers = cleaned.match(/[XxNT+-]/g)?.join('') || '';
                    if (level) {
                        cleaned = level + suit + modifiers;
                    }
                }
            }
            
            // If still doesn't match valid pattern, try to extract what we can
            const validPattern = /[1-7][‚ô†‚ô•‚ô¶‚ô£NT]/i;
            if (!validPattern.test(cleaned)) {
                // Try to find level and suit and reconstruct
                const level = cleaned.match(/[1-7]/)?.[0];
                const suit = cleaned.match(/[‚ô†‚ô•‚ô¶‚ô£NT]+/i)?.[0];
                const modifiers = cleaned.match(/[XxNT+-]/g)?.join('') || '';
                
                if (level && suit) {
                    cleaned = level + suit + modifiers;
                } else {
                    return 'N/A';
                }
            }
            
            return formatSuitWithColor(cleaned);
        }
        
        function formatLead(lead) {
            if (!lead) return '-';
            return formatSuitWithColor(lead);
        }
        
        function formatSuitRow(symbol, holding, isRed) {
            const colorClass = isRed ? 'suit-red' : 'suit-black';
            return `<div class="suitRowDivStyle"><span class="suitSymbol ${colorClass}">${symbol}</span><span class="suitHolding">${holding || '-'}</span></div>`;
        }
        
        function calculateHCP(hand) {
            if (!hand || !hand.S) return 0;
            let hcp = 0;
            const cards = (hand.S || '') + (hand.H || '') + (hand.D || '') + (hand.C || '');
            for (const c of cards) {
                if (c === 'A') hcp += 4;
                else if (c === 'K') hcp += 3;
                else if (c === 'Q') hcp += 2;
                else if (c === 'J') hcp += 1;
            }
            return hcp;
        }
        
        function renderDDTable(ddResult) {
            if (!ddResult) return '';
            
            const suits = ['S', 'H', 'D', 'C', 'NT'];
            const suitSymbols = {
                'S': '<span class="suit-symbol suit-black">‚ô†</span>',
                'H': '<span class="suit-symbol suit-red">‚ô•</span>',
                'D': '<span class="suit-symbol suit-red">‚ô¶</span>',
                'C': '<span class="suit-symbol suit-black">‚ô£</span>',
                'NT': 'NT'
            };
            
            // Format tricks: 7+ shows as 1+, below 7 shows as dash
            function formatTricks(tricks) {
                if (tricks === undefined || tricks === null) return '-';
                if (tricks >= 7) return tricks - 6;
                return '-';
            }
            
            let html = '<table class="bh-dd"><tr><th></th>';
            suits.forEach(s => html += `<th>${suitSymbols[s]}</th>`);
            html += '</tr>';
            
            ['N', 'S', 'E', 'W'].forEach(pos => {
                html += `<tr><td>${pos}</td>`;
                suits.forEach(suit => {
                    // API returns nested format: ddResult.N.C, ddResult.N.D, etc.
                    const tricks = ddResult[pos] ? ddResult[pos][suit] : undefined;
                    html += `<td>${formatTricks(tricks)}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</table>';
            return html;
        }
        
        // String formatƒ±ndaki eli obje formatƒ±na d√∂n√º≈üt√ºr
        // "T9752.9732.J72.3" -> {S: "T9752", H: "9732", D: "J72", C: "3"}
        function parseHandString(handStr) {
            if (!handStr) return null;
            if (typeof handStr === 'object') return handStr; // Zaten obje ise
            const parts = handStr.split('.');
            if (parts.length !== 4) return null;
            return {
                S: parts[0] || '-',
                H: parts[1] || '-',
                D: parts[2] || '-',
                C: parts[3] || '-'
            };
        }
        
        function renderHandDiagram(handData, boardNum, ddResult, optimum, lott) {
            console.log('renderHandDiagram called with:', { boardNum, ddResult, optimum, lott });
            
            if (!handData) {
                return '<div class="hand-diagram-container"><div style="color:#aaa;padding:20px;">El verisi bulunamadƒ±</div></div>';
            }
            
            // Handle nested 'hands' structure or flat structure
            const handsObj = handData.hands || handData;
            
            if (!handsObj || !handsObj.N) {
                return '<div class="hand-diagram-container"><div style="color:#aaa;padding:20px;">El verisi bulunamadƒ±</div></div>';
            }
            
            // String formatƒ±nƒ± obje formatƒ±na d√∂n√º≈üt√ºr
            const n = parseHandString(handsObj.N);
            const s = parseHandString(handsObj.S);
            const e = parseHandString(handsObj.E);
            const w = parseHandString(handsObj.W);
            
            if (!n || !s || !e || !w) {
                return '<div class="hand-diagram-container"><div style="color:#aaa;padding:20px;">El verisi ge√ßersiz</div></div>';
            }
            const dealer = handData.dealer || 'N';
            const vul = handData.vulnerability || 'None';
            const date = handData.date || '';
            
            const hcpN = calculateHCP(n);
            const hcpS = calculateHCP(s);
            const hcpE = calculateHCP(e);
            const hcpW = calculateHCP(w);
            
            // Dealer class
            const nDealerClass = dealer === 'N' ? 'dealer-bg' : '';
            const sDealerClass = dealer === 'S' ? 'dealer-bg' : '';
            const eDealerClass = dealer === 'E' ? 'dealer-bg' : '';
            const wDealerClass = dealer === 'W' ? 'dealer-bg' : '';
            
            // Format optimum text with suit colors
            const optimumTextColored = optimum && optimum.text ? formatSuitWithColor(optimum.text) : '';
            
            // DD Table HTML
            const ddTableHtml = ddResult ? `
                <div class="bhDoubleDummy">
                    ${renderDDTable(ddResult)}
                    ${optimum ? `<div class="par-display"><strong>Par: ${optimum.score || ''}</strong> ${optimumTextColored}</div>` : ''}
                </div>
            ` : '<div class="bhDoubleDummy" style="color:red;text-align:center;padding:10px;">DD Verisi Yok</div>';
            
            // Format LoTT suit symbols with colors
            const nsFitSuit = lott && lott.ns_fit ? formatSuitWithColor(lott.ns_fit.suit || '?') : '?';
            const ewFitSuit = lott && lott.ew_fit ? formatSuitWithColor(lott.ew_fit.suit || '?') : '?';
            
            // LoTT HTML - show total_tricks as main value, details show NS/EW fits
            const lottHtml = lott ? `
                <div class="lottDisplay">
                    <div class="lott-title">LoTT</div>
                    <div class="lott-value">${lott.total_tricks || '?'}</div>
                    ${lott.ns_fit ? `
                    <div class="lott-detail">
                        NS: ${nsFitSuit} (${lott.ns_fit.length || '?'})<br>
                        EW: ${ewFitSuit} (${lott.ew_fit?.length || '?'})
                    </div>
                    ` : ''}
                </div>
            ` : '';
            
            return `
                <div class="hand-diagram-container">
                    <div class="scale-wrapper">
                        <div class="mainDivStyle">
                            <!-- Board Info - Left Side -->
                            <div class="board-info-left">
                                <div class="date">${date}</div>
                                <div class="dealer">Dealer: ${dealer}</div>
                                <div class="vul ${vul && vul.toLowerCase() !== 'none' && vul !== '-' ? 'vul-active' : ''}">Vul: ${vul}</div>
                            </div>
                            
                            <!-- HCP Display - Right Side -->
                        <div class="hcp-display">
                            <div class="hcp-north"><span class="hcp-value">${hcpN}</span></div>
                            <div class="hcp-middle">
                                <span class="hcp-value">${hcpW}</span>
                                <span class="hcp-value">${hcpE}</span>
                            </div>
                            <div class="hcp-south"><span class="hcp-value">${hcpS}</span></div>
                        </div>
                        
                        <!-- North -->
                        <div class="nameRowDivStyle pos-n-name ${nDealerClass}">
                            <span class="nameInitial">N</span>
                        </div>
                        <div class="handDivStyle pos-n-hand">
                            ${formatSuitRow('‚ô†', n.S, false)}
                            ${formatSuitRow('‚ô•', n.H, true)}
                            ${formatSuitRow('‚ô¶', n.D, true)}
                            ${formatSuitRow('‚ô£', n.C, false)}
                        </div>
                        
                        <!-- West -->
                        <div class="nameRowDivStyle pos-w-name ${wDealerClass}">
                            <span class="nameInitial">W</span>
                        </div>
                        <div class="handDivStyle pos-w-hand">
                            ${formatSuitRow('‚ô†', w.S, false)}
                            ${formatSuitRow('‚ô•', w.H, true)}
                            ${formatSuitRow('‚ô¶', w.D, true)}
                            ${formatSuitRow('‚ô£', w.C, false)}
                        </div>
                        
                        <!-- Board Number -->
                        <div class="vulInnerDivStyle pos-board">${boardNum}</div>
                        
                        <!-- East -->
                        <div class="nameRowDivStyle pos-e-name ${eDealerClass}">
                            <span class="nameInitial">E</span>
                        </div>
                        <div class="handDivStyle pos-e-hand">
                            ${formatSuitRow('‚ô†', e.S, false)}
                            ${formatSuitRow('‚ô•', e.H, true)}
                            ${formatSuitRow('‚ô¶', e.D, true)}
                            ${formatSuitRow('‚ô£', e.C, false)}
                        </div>
                        
                        <!-- South -->
                        <div class="nameRowDivStyle pos-s-name ${sDealerClass}">
                            <span class="nameInitial">S</span>
                        </div>
                        <div class="handDivStyle pos-s-hand">
                            ${formatSuitRow('‚ô†', s.S, false)}
                            ${formatSuitRow('‚ô•', s.H, true)}
                            ${formatSuitRow('‚ô¶', s.D, true)}
                            ${formatSuitRow('‚ô£', s.C, false)}
                        </div>
                        
                        ${ddTableHtml}
                        ${lottHtml}
                    </div>
                    </div>
                </div>
            `;
        }
        
        // Parse PBN hand string to object
        function parsePBNHand(pbnString) {
            if (!pbnString) return {S: '-', H: '-', D: '-', C: '-'};
            const parts = pbnString.split('.');
            return {
                S: parts[0] || '-',
                H: parts[1] || '-',
                D: parts[2] || '-',
                C: parts[3] || '-'
            };
        }
        
        // Format hand in BBO style
        function formatHandBBO(hand) {
            if (!hand) return '-';
            const suitSymbols = {'S': '‚ô†', 'H': '‚ô•', 'D': '‚ô¶', 'C': '‚ô£'};
            const suits = ['S', 'H', 'D', 'C'];
            let result = '';
            for (let suit of suits) {
                const cards = hand[suit] || '-';
                if (result) result += ' ';
                result += suitSymbols[suit] + cards;
            }
            return result;
        }
        
        // Display hands diagram
        function displayHandDiagram(hand) {
            if (!hand) {
                document.getElementById('handDiagram').classList.remove('show');
                return;
            }
            
            const nHand = parsePBNHand(hand.N);
            const eHand = parsePBNHand(hand.E);
            const sHand = parsePBNHand(hand.S);
            const wHand = parsePBNHand(hand.W);
            
            document.getElementById('diagramBoardNum').textContent = hand.board;
            document.getElementById('handN').innerHTML = formatHandBBO(nHand);
            document.getElementById('handE').innerHTML = formatHandBBO(eHand);
            document.getElementById('handS').innerHTML = formatHandBBO(sHand);
            document.getElementById('handW').innerHTML = formatHandBBO(wHand);
            
            document.getElementById('handDiagram').classList.add('show');
        }
        
        async function loadRanking() {
            const eventId = document.getElementById('eventId').value.trim();
            const boardNum = document.getElementById('boardNum').value;
            
            if (!eventId) {
                alert('Event ID giriniz');
                return;
            }
            
            currentEventId = eventId;
            currentBoard = parseInt(boardNum);
            
            const content = document.getElementById('content');
            const loadBtn = document.getElementById('loadBtn');
            
            if (loadBtn) loadBtn.disabled = true;
            
            // 1. √ñnce el verisini hƒ±zlƒ±ca y√ºkle
            let handResult = null;
            try {
                const handResponse = await fetch(`/api/hand-data?event=${eventId}&board=${boardNum}`);
                handResult = await handResponse.json();
                console.log('Hand result:', handResult);
                console.log('dd_result:', handResult.dd_result);
                console.log('optimum:', handResult.optimum);
                console.log('lott:', handResult.lott);
                
                if (handResult.hand_data) {
                    // Display hand diagram
                    displayHandDiagram(handResult.hand_data);
                    
                    // El diyagramƒ±nƒ± g√∂ster (DD ve LoTT dahil)
                    let html = renderHandDiagram(
                        handResult.hand_data, 
                        currentBoard,
                        handResult.dd_result,
                        handResult.optimum,
                        handResult.lott
                    );
                    html += '<div class="loading">Sƒ±ralama y√ºkleniyor</div>';
                    content.innerHTML = html;
                    
                    // Tournament info g√ºncelle
                    document.getElementById('tournamentInfo').textContent = 
                        `Tarih: ${handResult.hand_data.date || ''}`;
                    
                    // Show navigation
                    document.getElementById('boardNav').style.display = 'flex';
                    document.getElementById('currentBoard').textContent = `Board ${currentBoard}`;
                    document.getElementById('prevBtn').disabled = currentBoard <= 1;
                    document.getElementById('nextBtn').disabled = currentBoard >= 30;
                }
            } catch (e) {
                console.error('Hand data error:', e);
            }
            
            // 2. Sonra ranking listesini y√ºkle (yava≈ü)
            try {
                const response = await fetch(`/api/board-ranking?event=${eventId}&board=${boardNum}`);
                const data = await response.json();
                
                if (data.error) {
                    // Hata durumunda sadece el diyagramƒ±nƒ± g√∂ster
                    if (handResult && handResult.hand_data) {
                        content.innerHTML = renderHandDiagram(
                            handResult.hand_data, 
                            currentBoard,
                            handResult.dd_result,
                            handResult.optimum,
                            handResult.lott
                        ) + `<div class="error">Sƒ±ralama y√ºklenemedi: ${data.error}</div>`;
                    } else {
                        content.innerHTML = `<div class="error">Hata: ${data.error}</div>`;
                    }
                    return;
                }
                
                // Update tournament info
                document.getElementById('tournamentInfo').textContent = 
                    `${data.tournament_name || 'Turnuva'} - ${data.tournament_date || ''}`;
                
                // Hand Diagram (DD ve LoTT dahil)
                let html = renderHandDiagram(
                    handResult ? handResult.hand_data : data.hand_data, 
                    data.board,
                    handResult ? handResult.dd_result : null,
                    handResult ? handResult.optimum : null,
                    handResult ? handResult.lott : null
                );
                
                // Sƒ±ralama verisi yoksa mesaj g√∂ster
                if (!data.results || data.results.length === 0) {
                    html += `
                        <div class="error" style="background: rgba(255,165,0,0.1); color: #ffa500; margin-top: 15px;">
                            ‚è≥ Bu board i√ßin sƒ±ralama verisi hen√ºz y√ºklenmedi.<br>
                            <small>Veriler periyodik olarak g√ºncellenmektedir.</small>
                        </div>
                    `;
                    content.innerHTML = html;
                    return;
                }
                
                // Build results table
                html += `
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Sƒ±ra</th>
                                <th>Oyuncular</th>
                                <th>Kontrat</th>
                                <th>Atak</th>
                                <th>Sonu√ß</th>
                                <th>Skor</th>
                                <th>%</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                for (const r of data.results) {
                    const rowClass = r.direction === 'NS' ? 'ns-row' : 'ew-row';
                    const rankClass = r.rank <= 3 ? `rank-${r.rank}` : '';
                    const dirBadge = `<span class="direction-badge direction-${r.direction.toLowerCase()}">${r.direction}</span>`;
                    
                    const score = String(r.score || '');
                    const displayScore = score.startsWith('-') ? score.substring(1) : score;
                    
                    // Kontrat + Deklaran
                    const contractDisplay = r.contract ? `${formatContract(r.contract)} ${r.declarer}` : '-';
                    
                    // Y√ºzde rengi: >= 50 ye≈üil, < 50 kƒ±rmƒ±zƒ±
                    const percentClass = r.percent >= 50 ? 'percent-high' : 'percent-low';
                    
                    html += `
                        <tr class="${rowClass}">
                            <td class="rank-cell ${rankClass}">${r.rank}</td>
                            <td class="player-cell">${r.pair_names}${dirBadge}</td>
                            <td class="contract-cell">${contractDisplay}</td>
                            <td>${formatLead(r.lead)}</td>
                            <td>${r.result || '='}</td>
                            <td class="score-cell">${displayScore || '-'}</td>
                            <td class="percent-cell ${percentClass}">${r.percent.toFixed(2)}%</td>
                        </tr>
                    `;
                }
                
                html += '</tbody></table>';
                
                content.innerHTML = html;
                
            } catch (error) {
                content.innerHTML = `<div class="error">Baƒülantƒ± hatasƒ±: ${error.message}</div>`;
            } finally {
                if (loadBtn) loadBtn.disabled = false;
            }
        }
        
        function changeBoard(delta) {
            const newBoard = currentBoard + delta;
            if (newBoard >= 1 && newBoard <= 30) {
                document.getElementById('boardNum').value = newBoard;
                loadRanking();
            }
        }
        
        // URL parametrelerinden y√ºkle
        window.onload = async function() {
            const params = new URLSearchParams(window.location.search);
            const content = document.getElementById('content');
            
            console.log('URL params:', Object.fromEntries(params));
            
            // Embed modunda ba≈ülƒ±k ve kapatma butonunu gizle
            if (params.get('embed') === '1') {
                const headerContainer = document.getElementById('headerContainer');
                if (headerContainer) {
                    headerContainer.style.display = 'none';
                }
                // Container'ƒ±n √ºst padding'ini azalt
                const container = document.querySelector('.container');
                if (container) {
                    container.style.paddingTop = '5px';
                }
                // Body scroll ayarlarƒ±
                document.body.style.overflow = 'auto';
                document.body.style.overflowX = 'hidden';
                document.body.style.height = 'auto';
                document.body.style.minHeight = 'auto';
                document.body.style.padding = '10px';
                // HTML element scroll
                document.documentElement.style.overflow = 'auto';
                document.documentElement.style.height = 'auto';
            }
            
            // Eƒüer date parametresi varsa, o tarihteki event'i bul
            if (params.get('date') && !params.get('event')) {
                const targetDate = params.get('date');
                console.log('Looking for date:', targetDate);
                
                content.innerHTML = '<div class="loading">Turnuva aranƒ±yor...</div>';
                
                try {
                    const response = await fetch('/database.json');
                    const db = await response.json();
                    const records = db.legacy_records || [];
                    
                    console.log('Total records:', records.length);
                    console.log('Sample dates:', records.slice(0, 3).map(r => r.Tarih));
                    
                    // Bu tarihteki ilk event'i bul
                    const matchingRecord = records.find(r => r.Tarih === targetDate && r.Link);
                    console.log('Matching record:', matchingRecord);
                    
                    if (matchingRecord && matchingRecord.Link) {
                        const match = matchingRecord.Link.match(/event=(\d+)/);
                        if (match) {
                            document.getElementById('eventId').value = match[1];
                            console.log('Found event:', match[1]);
                        }
                    } else {
                        content.innerHTML = `<div class="error">‚ùå "${targetDate}" tarihi i√ßin turnuva bulunamadƒ±.<br>Database format: dd.mm.yyyy (√∂rn: 01.01.2026)</div>`;
                        return;
                    }
                } catch (e) {
                    console.error('Error loading database for date lookup:', e);
                    content.innerHTML = `<div class="error">Database y√ºklenirken hata: ${e.message}</div>`;
                    return;
                }
            }
            
            let eventId = params.get('event') || params.get('eventId');
            if (eventId) {
                document.getElementById('eventId').value = eventId;
            }
            const boardNum = params.get('board');
            if (boardNum) {
                document.getElementById('boardNum').value = boardNum;
            }
            
            // Initialize filters
            initializeFilters();
            
            // Event ID varsa (URL'den veya date'den bulunmu≈üsa) y√ºkle
            console.log('Final eventId:', eventId);
            
            if (eventId) {
                loadRanking();
            }
            
            // Service Worker kayƒ±t
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('SW registered:', reg.scope))
                    .catch(err => console.log('SW registration failed:', err));
            }
        };
        
        // Initialize filters
        async function initializeFilters() {
            try {
                const [eventsResp, handsResp] = await Promise.all([
                    fetch('/database.json'),
                    fetch('/hands_database.json')
                ]);
                
                const db = await eventsResp.json();
                allEvents = db.events || {};
                allHands = await handsResp.json();
                
                // Populate date filter
                const dates = new Set();
                Object.values(allEvents).forEach(event => {
                    dates.add(event.date);
                });
                
                const sortedDates = Array.from(dates).sort((a, b) => {
                    const [dA, mA, yA] = a.split('.');
                    const [dB, mB, yB] = b.split('.');
                    return new Date(yB, mB - 1, dB) - new Date(yA, mA - 1, dA);
                });
                
                const dateSelect = document.getElementById('filterDate');
                sortedDates.forEach(date => {
                    const option = document.createElement('option');
                    option.value = date;
                    option.textContent = date;
                    dateSelect.appendChild(option);
                });
                
                // Populate event filter
                Object.values(allEvents).forEach(event => {
                    const option = document.createElement('option');
                    option.value = event.id;
                    option.textContent = `${event.name} (${event.date})`;
                    document.getElementById('filterEvent').appendChild(option);
                });
                
                // Add filter event listeners
                document.getElementById('filterDate').addEventListener('change', applyFiltersToRanking);
                document.getElementById('filterEvent').addEventListener('change', applyFiltersToRanking);
                document.getElementById('filterBoard').addEventListener('change', applyFiltersToRanking);
                document.getElementById('filterBoard').addEventListener('input', applyFiltersToRanking);
                
                // Show filters
                document.getElementById('filterControls').style.display = 'flex';
                
            } catch (error) {
                console.error('Error initializing filters:', error);
            }
        }
        
        // Apply filters to ranking
        function applyFiltersToRanking() {
            const selectedDate = document.getElementById('filterDate').value;
            const selectedEvent = document.getElementById('filterEvent').value;
            const selectedBoard = document.getElementById('filterBoard').value;
            
            // If event filter is used, set the event ID
            if (selectedEvent) {
                document.getElementById('eventId').value = selectedEvent;
                currentEventId = selectedEvent;
            }
            
            // If board filter is used, set the board
            if (selectedBoard) {
                document.getElementById('boardNum').value = selectedBoard;
                currentBoard = parseInt(selectedBoard);
            }
            
            // Load ranking with filters
            loadRanking();
        }
        
        // Touch gestures for board navigation
        let touchStartX = 0;
        let touchEndX = 0;
        
        document.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        }, { passive: true });
        
        document.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, { passive: true });
        
        function handleSwipe() {
            const diff = touchStartX - touchEndX;
            const threshold = 80;
            
            if (Math.abs(diff) > threshold && currentEventId) {
                if (diff > 0) {
                    // Swipe left - next board
                    changeBoard(1);
                } else {
                    // Swipe right - previous board
                    changeBoard(-1);
                }
            }
        }
    </script>
</body>
</html>
