<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bridge Boards Grid View</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .header h1 {
            color: #1e3c72;
            margin-bottom: 20px;
            font-size: 28px;
        }

        .filters {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 0.9em;
            font-weight: 600;
            color: #1e3c72;
        }

        .filter-group input,
        .filter-group select {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: border-color 0.3s;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #2a5298;
        }

        .btn-load {
            padding: 10px 30px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            align-self: flex-end;
        }

        .btn-load:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .btn-load:active {
            transform: translateY(0);
        }

        .status-info {
            color: #666;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .boards-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }

        /* Tablet: 2 columns */
        @media (max-width: 1024px) {
            .boards-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Mobile: 1 column */
        @media (max-width: 768px) {
            .boards-grid {
                grid-template-columns: 1fr;
            }

            .header {
                padding: 15px 20px;
            }

            .header h1 {
                font-size: 22px;
            }

            .filters {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group input,
            .filter-group select {
                padding: 12px;
            }

            .btn-load {
                align-self: stretch;
            }
        }

        .board-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .board-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .scale-wrapper {
            padding: 15px;
            overflow: auto;
        }

        .mainDivStyle {
            position: relative;
            width: 360px;
            height: 360px;
            margin: auto;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .board-info-left {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 11px;
            z-index: 5;
        }

        .date {
            font-weight: 600;
            color: #1e3c72;
            margin-bottom: 2px;
            display: none;
        }

        .dealer {
            font-size: 10px;
            color: #666;
        }

        .vul {
            font-size: 10px;
            color: #666;
        }

        .vul-active {
            color: #d32f2f;
            font-weight: 600;
        }

        .hcp-display {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 13px;
            text-align: center;
            z-index: 5;
        }

        .hcp-north {
            margin-bottom: 5px;
            font-weight: 600;
            color: #1e3c72;
        }

        .hcp-middle {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 5px;
        }

        .hcp-middle span {
            font-weight: 600;
            color: #2a5298;
        }

        .hcp-south {
            font-weight: 600;
            color: #1e3c72;
        }

        .hcp-value {
            display: inline-block;
            min-width: 20px;
        }

        .nameRowDivStyle {
            position: absolute;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            border-radius: 5px;
            font-weight: bold;
            color: #1e3c72;
            font-size: 16px;
            z-index: 4;
        }

        .dealer-bg {
            background: #fff3cd !important;
            border: 2px solid #ffc107 !important;
        }

        .pos-n-name {
            top: 10px;
            left: 160px;
        }

        .pos-s-name {
            bottom: 10px;
            left: 160px;
        }

        .pos-w-name {
            top: 160px;
            left: 10px;
        }

        .pos-e-name {
            top: 160px;
            right: 10px;
        }

        .handDivStyle {
            position: absolute;
            width: 140px;
            font-size: 11px;
            line-height: 1.4;
            z-index: 3;
        }

        .pos-n-hand {
            top: 60px;
            left: 110px;
            text-align: center;
        }

        .pos-s-hand {
            bottom: 60px;
            left: 110px;
            text-align: center;
        }

        .pos-w-hand {
            top: 110px;
            left: 10px;
            text-align: right;
            padding-right: 10px;
        }

        .pos-e-hand {
            top: 110px;
            right: 10px;
            text-align: left;
            padding-left: 10px;
        }

        .suit-row {
            display: flex;
            align-items: center;
            gap: 3px;
            margin: 1px 0;
        }

        .suit-symbol {
            min-width: 12px;
            font-weight: bold;
        }

        .spade {
            color: #000;
        }

        .heart {
            color: #d32f2f;
        }

        .diamond {
            color: #f57c00;
        }

        .club {
            color: #388e3c;
        }

        .vulInnerDivStyle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: bold;
            color: #ddd;
            z-index: 1;
        }

        .bhDoubleDummy {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: #f5f5f5;
            border-radius: 5px;
            padding: 8px;
            font-size: 10px;
            z-index: 4;
        }

        .dd-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px;
            line-height: 1.3;
        }

        .dd-table th,
        .dd-table td {
            border: 1px solid #ddd;
            padding: 3px;
            text-align: center;
        }

        .dd-table th {
            background: #1e3c72;
            color: white;
            font-weight: 600;
        }

        .dd-table tr:nth-child(odd) {
            background: white;
        }

        .dd-table tr:nth-child(even) {
            background: #fafafa;
        }

        .par-display {
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px solid #ddd;
            font-weight: 600;
            color: #1e3c72;
        }

        .lottDisplay {
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px solid #ddd;
            text-align: center;
        }

        .lott-title {
            font-weight: 600;
            color: #1e3c72;
            margin-bottom: 2px;
        }

        .lott-value {
            font-size: 12px;
            font-weight: bold;
            color: #d32f2f;
        }

        .lott-detail {
            font-size: 9px;
            color: #666;
            margin-top: 2px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }

        .loading::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .error {
            background: rgba(255, 107, 107, 0.2);
            border: 2px solid #ff6b6b;
            color: #ff6b6b;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }

        .no-data {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 10px;
            text-align: center;
            color: #666;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Bridge Boards Grid View</h1>
            <div class="filters">
                <div class="filter-group">
                    <label for="dateSelect">Select Date:</label>
                    <select id="dateSelect" onchange="updateEvents()">
                        <option value="">-- Choose Date --</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="eventSelect">Select Event:</label>
                    <select id="eventSelect">
                        <option value="">-- Choose Event --</option>
                    </select>
                </div>
                <button class="btn-load" onclick="loadBoards()">Load Boards</button>
            </div>
            <div class="status-info" id="statusInfo"></div>
        </div>

        <div id="boardsContainer" class="boards-grid"></div>
    </div>

    <script>
        let allEvents = {};
        let allHands = [];
        let uniqueDates = [];

        // Initialize
        async function init() {
            try {
                console.log('Initializing...');
                
                // Load events
                const eventsRes = await fetch('/database.json');
                allEvents = await eventsRes.json();
                console.log('Events loaded:', Object.keys(allEvents.events || {}).length);

                // Load hands
                const handsRes = await fetch('/hands_database.json');
                allHands = await handsRes.json();
                console.log('Hands loaded:', allHands.length);

                // Extract unique dates
                uniqueDates = [...new Set(allHands.map(h => h.date))].sort();
                console.log('Unique dates:', uniqueDates);

                // Populate date selector
                const dateSelect = document.getElementById('dateSelect');
                uniqueDates.forEach(date => {
                    const option = document.createElement('option');
                    option.value = date;
                    option.textContent = date;
                    dateSelect.appendChild(option);
                });

                // Set first date as default
                if (uniqueDates.length > 0) {
                    dateSelect.value = uniqueDates[0];
                    updateEvents();
                }
                
                console.log('Init complete');
            } catch (e) {
                console.error('Init error:', e);
            }
        }

        function updateEvents() {
            const selectedDate = document.getElementById('dateSelect').value;
            const eventSelect = document.getElementById('eventSelect');

            eventSelect.innerHTML = '<option value="">-- Choose Event --</option>';

            if (!selectedDate) {
                return;
            }

            // Get events for selected date
            const eventsForDate = [...new Set(
                allHands
                    .filter(h => h.date === selectedDate)
                    .map(h => String(h.event_id))
            )].sort((a, b) => parseInt(a) - parseInt(b));

            eventsForDate.forEach(eventId => {
                const eventName = allEvents.events?.[`event_${eventId}`]?.name || `Event ${eventId}`;
                const option = document.createElement('option');
                option.value = eventId;
                option.textContent = eventName;
                eventSelect.appendChild(option);
            });

            // Auto-select first event
            if (eventsForDate.length > 0) {
                eventSelect.value = eventsForDate[0];
            }
        }

        function formatSuitWithColor(suit) {
            const suitMap = {
                'S': '<span class="suit-symbol spade">♠</span>',
                'H': '<span class="suit-symbol heart">♥</span>',
                'D': '<span class="suit-symbol diamond">♦</span>',
                'C': '<span class="suit-symbol club">♣</span>',
                '?': '<span class="suit-symbol">?</span>'
            };
            return suitMap[suit] || suit;
        }

        function formatSuitRow(suit, cards, isRed) {
            const suitClass = suit === '♠' ? 'spade' : suit === '♥' ? 'heart' : suit === '♦' ? 'diamond' : 'club';
            return `<div class="suit-row"><span class="suit-symbol ${suitClass}">${suit}</span><span>${cards || '-'}</span></div>`;
        }

        function parseHandString(handStr) {
            if (!handStr) return { S: '-', H: '-', D: '-', C: '-' };
            const parts = handStr.split('.');
            return {
                S: parts[0] || '-',
                H: parts[1] || '-',
                D: parts[2] || '-',
                C: parts[3] || '-'
            };
        }

        function calculateHCP(hand) {
            if (!hand) return 0;
            const values = { A: 4, K: 3, Q: 2, J: 1 };
            let hcp = 0;
            Object.values(hand).forEach(suit => {
                if (suit && suit !== '-') {
                    suit.split('').forEach(card => {
                        hcp += values[card] || 0;
                    });
                }
            });
            return hcp;
        }

        function renderDDTable(ddResult) {
            if (!ddResult || typeof ddResult !== 'object') {
                return '<div style="color:red;text-align:center;padding:10px;">DD Data unavailable</div>';
            }

            const suits = ['NT', 'S', 'H', 'D', 'C'];
            let html = '<table class="dd-table"><tr><th>Contract</th>';
            ['N', 'E', 'S', 'W'].forEach(dir => {
                html += `<th>${dir}</th>`;
            });
            html += '</tr>';

            suits.forEach(suit => {
                html += `<tr><td>${suit}</td>`;
                ['N', 'E', 'S', 'W'].forEach(dir => {
                    const value = ddResult[suit]?.[dir] || '-';
                    html += `<td>${value}</td>`;
                });
                html += '</tr>';
            });

            html += '</table>';
            return html;
        }

        function renderBoardCard(hand, ddResult, optimum, lott) {
            const n = parseHandString(hand.N);
            const s = parseHandString(hand.S);
            const e = parseHandString(hand.E);
            const w = parseHandString(hand.W);

            const hcpN = calculateHCP(n);
            const hcpS = calculateHCP(s);
            const hcpE = calculateHCP(e);
            const hcpW = calculateHCP(w);

            const dealer = hand.dealer || 'N';
            const vul = hand.vulnerability || 'None';
            const date = hand.date || '';
            const boardNum = hand.board || '';

            const nDealerClass = dealer === 'N' ? 'dealer-bg' : '';
            const sDealerClass = dealer === 'S' ? 'dealer-bg' : '';
            const eDealerClass = dealer === 'E' ? 'dealer-bg' : '';
            const wDealerClass = dealer === 'W' ? 'dealer-bg' : '';

            const optimumTextColored = optimum?.text ? formatSuitWithColor(optimum.text) : '';

            const ddTableHtml = ddResult ? renderDDTable(ddResult) : '<div style="color:red;text-align:center;padding:10px;">DD unavailable</div>';

            const nsFitSuit = lott?.ns_fit ? formatSuitWithColor(lott.ns_fit.suit || '?') : '?';
            const ewFitSuit = lott?.ew_fit ? formatSuitWithColor(lott.ew_fit.suit || '?') : '?';

            const lottHtml = lott ? `
                <div class="lottDisplay">
                    <div class="lott-title">LoTT</div>
                    <div class="lott-value">${lott.total_tricks || '?'}</div>
                    ${lott.ns_fit ? `
                    <div class="lott-detail">
                        NS: ${nsFitSuit} (${lott.ns_fit.length || '?'})<br>
                        EW: ${ewFitSuit} (${lott.ew_fit?.length || '?'})
                    </div>
                    ` : ''}
                </div>
            ` : '';

            return `
                <div class="board-card">
                    <div class="scale-wrapper">
                        <div class="mainDivStyle">
                            <div class="board-info-left">
                                <div class="date">${date}</div>
                                <div class="dealer">Dealer: ${dealer}</div>
                                <div class="vul ${vul && vul.toLowerCase() !== 'none' && vul !== '-' ? 'vul-active' : ''}">Vul: ${vul}</div>
                            </div>
                            
                            <div class="hcp-display">
                                <div class="hcp-north"><span class="hcp-value">${hcpN}</span></div>
                                <div class="hcp-middle">
                                    <span class="hcp-value">${hcpW}</span>
                                    <span class="hcp-value">${hcpE}</span>
                                </div>
                                <div class="hcp-south"><span class="hcp-value">${hcpS}</span></div>
                            </div>
                            
                            <div class="nameRowDivStyle pos-n-name ${nDealerClass}">
                                <span class="nameInitial">N</span>
                            </div>
                            <div class="handDivStyle pos-n-hand">
                                ${formatSuitRow('♠', n.S, false)}
                                ${formatSuitRow('♥', n.H, true)}
                                ${formatSuitRow('♦', n.D, true)}
                                ${formatSuitRow('♣', n.C, false)}
                            </div>
                            
                            <div class="nameRowDivStyle pos-w-name ${wDealerClass}">
                                <span class="nameInitial">W</span>
                            </div>
                            <div class="handDivStyle pos-w-hand">
                                ${formatSuitRow('♠', w.S, false)}
                                ${formatSuitRow('♥', w.H, true)}
                                ${formatSuitRow('♦', w.D, true)}
                                ${formatSuitRow('♣', w.C, false)}
                            </div>
                            
                            <div class="vulInnerDivStyle">${boardNum}</div>
                            
                            <div class="nameRowDivStyle pos-e-name ${eDealerClass}">
                                <span class="nameInitial">E</span>
                            </div>
                            <div class="handDivStyle pos-e-hand">
                                ${formatSuitRow('♠', e.S, false)}
                                ${formatSuitRow('♥', e.H, true)}
                                ${formatSuitRow('♦', e.D, true)}
                                ${formatSuitRow('♣', e.C, false)}
                            </div>
                            
                            <div class="nameRowDivStyle pos-s-name ${sDealerClass}">
                                <span class="nameInitial">S</span>
                            </div>
                            <div class="handDivStyle pos-s-hand">
                                ${formatSuitRow('♠', s.S, false)}
                                ${formatSuitRow('♥', s.H, true)}
                                ${formatSuitRow('♦', s.D, true)}
                                ${formatSuitRow('♣', s.C, false)}
                            </div>
                            
                            <div class="bhDoubleDummy">
                                ${ddTableHtml}
                                ${optimum ? `<div class="par-display"><strong>Par: ${optimum.score || ''}</strong> ${optimumTextColored}</div>` : ''}
                                ${lottHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadBoards() {
            const selectedDate = document.getElementById('dateSelect').value;
            const selectedEvent = document.getElementById('eventSelect').value;

            console.log('Loading boards:', { selectedDate, selectedEvent });

            if (!selectedDate || !selectedEvent) {
                alert('Please select both date and event');
                return;
            }

            const container = document.getElementById('boardsContainer');
            container.innerHTML = '<div class="loading">Loading boards</div>';

            try {
                // Filter hands for selected date and event
                const handsForEvent = allHands
                    .filter(h => h.date === selectedDate && String(h.event_id) === selectedEvent)
                    .sort((a, b) => a.board - b.board);

                console.log('Hands found:', handsForEvent.length);

                if (handsForEvent.length === 0) {
                    container.innerHTML = '<div class="no-data">No boards found for selected date and event</div>';
                    return;
                }

                // Render all boards
                const boardsHtml = handsForEvent.map(hand => 
                    renderBoardCard(hand, hand.dd_analysis, hand.optimum, hand.lott)
                ).join('');

                container.innerHTML = boardsHtml;

                // Update status
                const eventName = allEvents.events?.[`event_${selectedEvent}`]?.name || `Event ${selectedEvent}`;
                document.getElementById('statusInfo').textContent = 
                    `Showing ${handsForEvent.length} boards - ${eventName} (${selectedDate})`;

            } catch (e) {
                console.error('Load error:', e);
                container.innerHTML = `<div class="error">Error loading boards: ${e.message}</div>`;
            }
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
