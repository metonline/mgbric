<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bridge Hands - Tournament Printout</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }
        
        .controls {
            text-align: center;
            margin-bottom: 20px;
        }
        
        button {
            padding: 8px 15px;
            background: #333;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        button:hover {
            background: #555;
        }
        
        .boards-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
            max-width: 100%;
        }
        
        .board-card {
            background: white;
            padding: 12px;
            border: 1px solid #ccc;
            page-break-inside: avoid;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .board-header {
            display: grid;
            grid-template-columns: 60px 1fr 200px;
            align-items: center;
            margin-bottom: 8px;
            padding: 4px 0;
            border-bottom: 1px solid #ccc;
            gap: 8px;
        }
        
        .board-header-left {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .board-header-center {
            text-align: center;
            font-size: 1.1rem;
            font-weight: bold;
        }
        
        .board-header-right {
            text-align: right;
            font-size: 0.9rem;
            color: #333;
        }
        
        .vuln-indicator {
            width: 50px;
            height: 50px;
            border: 2px solid #333;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 0;
            font-weight: bold;
            font-size: 0.7rem;
            text-align: center;
            line-height: 1.2;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            flex-shrink: 0;
        }
        
        .vuln-indicator:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .vuln-indicator:active {
            transform: scale(0.98);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .vuln-quad {
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #333;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        .vuln-quad:hover {
            opacity: 0.8;
        }
        
        .vuln-quad-n { grid-column: 1 / 3; }
        .vuln-quad-e { grid-row: 2; grid-column: 2; }
        .vuln-quad-s { grid-column: 1 / 3; grid-row: 3; }
        .vuln-quad-w { grid-row: 2; grid-column: 1; }
        .vuln-quad-dealer { grid-row: 2; grid-column: 1 / 3; font-weight: bold; }
        
        .vuln-red { background: #e74c3c; color: white; }
        .vuln-white { background: white; }

        .board-number {
            font-size: 1.1rem;
        }
        
        .board-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            flex: 1;
        }
        
        .bbo-viewer {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
        }
        
        .bbo-viewer.vuln-none {
            background: #e8f5e9;
            border: 2px solid #4caf50;
        }
        
        .bbo-viewer.vuln-ns {
            background: #fff3e0;
            border: 2px solid #ff9800;
        }
        
        .bbo-viewer.vuln-ew {
            background: #e3f2fd;
            border: 2px solid #2196f3;
        }
        
        .bbo-viewer.vuln-both {
            background: #fce4ec;
            border: 2px solid #e91e63;
        }
        
        .bbo-frame {
            width: 100%;
            height: auto;
            aspect-ratio: 4 / 3;
            border: 1px solid #999;
        }
        
        .dd-table-simple {
            width: 100%;
            border: 1px solid #333;
            display: flex;
            justify-content: center;
            padding: 4px;
        }
        
        .dd-table-simple table {
            border-collapse: collapse;
            font-family: Arial, sans-serif;
            width: auto;
        }
        
        .dd-table-simple th {
            background: white;
            border: 1px solid #333;
            padding: 5px 7px;
            text-align: center;
            font-weight: bold;
            font-size: 0.85rem;
        }
        
        .dd-table-simple td {
            border: 1px solid #333;
            padding: 5px 7px;
            text-align: center;
            min-width: 32px;
            font-size: 0.85rem;
            font-weight: bold;
        }
        
        .suit-C { color: #000; font-weight: bold; }
        .suit-D { color: #d00; font-weight: bold; }
        .suit-H { color: #d00; font-weight: bold; }
        .suit-S { color: #000; font-weight: bold; }
        .suit-NT { font-weight: bold; }
        
        .making {
            background: #c8e6c9 !important;
        }
        
        .results-section {
            margin-top: 10px;
            font-size: 0.8rem;
        }
        
        .results-section h4 {
            margin-bottom: 4px;
            font-weight: bold;
        }
        
        @media (max-width: 1280px) {
            .boards-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .boards-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .controls {
                display: none;
            }
            
            .board-card {
                page-break-inside: avoid;
                border: 1px solid #ddd;
            }
        }
        
        .loading, .error, .stats {
            text-align: center;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Bridge Tournament Hands</h1>

        <div id="loading" class="loading" style="display:none;">Loading tournament data...</div>
        <div id="error" class="error" style="display:none;"></div>

        <div class="boards-grid" id="boardsGrid"></div>

        <div class="stats" id="stats"></div>
    </div>

    <script>
        let allHands = [];
        let boardResults = {};

        function getVulnColor(player, vuln) {
            if (!vuln) return 'vuln-white';
            const v = vuln.toLowerCase().trim();
            
            // Both vulnerable = all red
            if (v === 'both' || v === 'all') return 'vuln-red';
            
            // None vulnerable = all white
            if (v === 'none' || v === '-') return 'vuln-white';
            
            // NS vulnerable: N and S are red, E and W are white
            if (v === 'ns' || v === 'n-s') {
                return (player === 'N' || player === 'S') ? 'vuln-red' : 'vuln-white';
            }
            
            // EW vulnerable: E and W are red, N and S are white
            if (v === 'ew' || v === 'e-w') {
                return (player === 'E' || player === 'W') ? 'vuln-red' : 'vuln-white';
            }
            
            return 'vuln-white';
        }

        function getVulnClass(vuln) {
            if (!vuln) return 'vuln-none';
            const v = vuln.toLowerCase().trim();
            if (v === 'none' || v === '-') return 'vuln-none';
            if (v === 'ns' || v === 'n-s') return 'vuln-ns';
            if (v === 'ew' || v === 'e-w') return 'vuln-ew';
            if (v === 'both' || v === 'all') return 'vuln-both';
            return 'vuln-none';
        }

        async function loadHands() {
            document.getElementById('loading').style.display = 'block';
            try {
                const response = await fetch('/api/hands');
                if (!response.ok) throw new Error('Failed to load hands');
                const handsObj = await response.json();
                allHands = Object.entries(handsObj).map(([id, hand]) => ({ id, ...hand }));
                
                // Try to load results for each board
                await loadBoardResults();
                
                renderAllBoards();
                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                document.getElementById('error').textContent = 'Error: ' + error.message;
                document.getElementById('error').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function loadBoardResults() {
            for (let hand of allHands) {
                try {
                    const filename = `board${hand.id}_results.json`;
                    const response = await fetch(`/${filename}`);
                    if (response.ok) {
                        boardResults[hand.id] = await response.json();
                    }
                } catch (e) {
                    // Silently skip if no results file
                }
            }
        }

        function generateLIN(hand) {
            const dealerMap = {'N':1,'E':2,'S':3,'W':4};
            const vulnMap = {'None':0,'NS':1,'EW':2,'Both':3};
            const dealer = dealerMap[hand.dealer] || 1;
            const vuln = vulnMap[hand.vulnerability] || 0;
            return `qx|o1|md|${dealer}${hand.N},${hand.E},${hand.S}|rh||ah|Board ${hand.id}|sv|${vuln}|pg||`;
        }

        function createDDTable(hand) {
            if (!hand.dd_analysis) {
                return '<div style="text-align:center;color:#999;padding:10px;">No DD data</div>';
            }

            const dd = hand.dd_analysis;
            const players = ['N', 'S', 'E', 'W'];
            const suits = [
                { symbol: '♣', key: 'C' },
                { symbol: '♦', key: 'D' },
                { symbol: '♥', key: 'H' },
                { symbol: '♠', key: 'S' },
                { symbol: 'NT', key: 'NT' }
            ];

            let html = '<table>';
            
            // Header
            html += '<tr>';
            html += '<th style="width: 25px;"></th>';
            suits.forEach(suit => {
                html += `<th class="suit-${suit.key}">${suit.symbol}</th>`;
            });
            html += '</tr>';
            
            // Rows
            players.forEach(player => {
                html += '<tr>';
                html += `<td style="font-weight: bold; text-align: center; width: 25px;">${player}</td>`;
                
                suits.forEach(suit => {
                    const key = suit.key + player;
                    const value = dd[key] || '-';
                    const isMaking = parseInt(value) >= 10;
                    const bgColor = (isMaking && value !== '-') ? '#c8e6c9' : 'white';
                    html += `<td style="background:${bgColor};">${value}</td>`;
                });
                
                html += '</tr>';
            });
            
            html += '</table>';
            return html;
        }

        function renderAllBoards() {
            const grid = document.getElementById('boardsGrid');
            grid.innerHTML = '';

            allHands.forEach((hand, index) => {
                const card = document.createElement('div');
                card.className = 'board-card';
                
                const lin = generateLIN(hand);
                const encoded = encodeURIComponent(lin);
                
                let html = `
                    <div class="board-header">
                        <div class="board-header-left">
                            <div class="vuln-indicator">
                                <div class="vuln-quad vuln-quad-n ${getVulnColor('N', hand.vulnerability)}">N</div>
                                <div class="vuln-quad vuln-quad-e ${getVulnColor('E', hand.vulnerability)}">E</div>
                                <div class="vuln-quad vuln-quad-dealer">${hand.dealer || '-'}</div>
                                <div class="vuln-quad vuln-quad-w ${getVulnColor('W', hand.vulnerability)}">W</div>
                                <div class="vuln-quad vuln-quad-s ${getVulnColor('S', hand.vulnerability)}">S</div>
                            </div>
                        </div>
                        <div class="board-header-center">Board ${hand.id}</div>
                        <div class="board-header-right">Dealer: ${hand.dealer} | Vuln: ${hand.vulnerability}</div>
                    </div>
                    <div class="board-content">
                        <div class="bbo-viewer ${getVulnClass(hand.vulnerability)}">
                            <iframe class="bbo-frame" src="https://www.bridgebase.com/tools/handviewer.html?lin=${encoded}"></iframe>
                        </div>
                        <div class="dd-table-simple">
                            ${createDDTable(hand)}
                        </div>
                    </div>
                `;

                card.innerHTML = html;
                grid.appendChild(card);
            });

            document.getElementById('stats').textContent = `Total: ${allHands.length} boards`;
        }

        function toggleCompact() {
            document.body.style.fontSize = document.body.style.fontSize === '12px' ? '14px' : '12px';
        }

        // Add interactivity to vulnerability indicators
        function setupVulnIndicators() {
            const indicators = document.querySelectorAll('.vuln-indicator');
            
            indicators.forEach(indicator => {
                // Click event
                indicator.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const board = this.closest('.board-card');
                    const boardNum = board.querySelector('.board-header-center').textContent;
                    const vulnText = board.querySelector('.board-header-right').textContent;
                    
                    // Highlight this board
                    document.querySelectorAll('.board-card').forEach(c => c.style.opacity = '0.5');
                    board.style.opacity = '1';
                    board.style.border = '3px solid #e74c3c';
                    
                    console.log(`Selected: ${boardNum} - ${vulnText}`);
                });
                
                // Touch event for mobile
                indicator.addEventListener('touchstart', function(e) {
                    this.style.transform = 'scale(0.95)';
                }, {passive: true});
                
                indicator.addEventListener('touchend', function(e) {
                    this.style.transform = '';
                    this.click();
                }, {passive: true});
                
                // Tooltip on hover showing vulnerability details
                indicator.addEventListener('mouseenter', function() {
                    const quad_n = this.querySelector('.vuln-quad-n');
                    let vulnInfo = this.closest('.board-card').querySelector('.board-header-right').textContent;
                    
                    const tooltip = document.createElement('div');
                    tooltip.style.cssText = `
                        position: absolute;
                        background: #333;
                        color: white;
                        padding: 8px 12px;
                        border-radius: 4px;
                        font-size: 12px;
                        white-space: nowrap;
                        pointer-events: none;
                        z-index: 1000;
                        margin-top: 5px;
                    `;
                    tooltip.textContent = 'Vuln: ' + vulnInfo;
                    tooltip.className = 'vuln-tooltip';
                    
                    const rect = this.getBoundingClientRect();
                    tooltip.style.left = (rect.left + rect.width / 2 - 40) + 'px';
                    tooltip.style.top = (rect.bottom + 5) + 'px';
                    
                    document.body.appendChild(tooltip);
                    
                    this.addEventListener('mouseleave', function() {
                        tooltip.remove();
                    }, {once: true});
                });
            });
        }

        // Load data on page load
        loadHands();
        
        // Setup interactivity after a short delay to ensure DOM is ready
        setTimeout(setupVulnIndicators, 100);
    </script>
</body>
</html>
