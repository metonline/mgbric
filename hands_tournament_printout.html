<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bridge Hands - Tournament Printout</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a472a 0%, #0f2818 100%);
            color: #333;
            padding: 15px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
        }
        
        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .controls {
            text-align: center;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        button {
            padding: 10px 20px;
            background: #2d5a3d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
            font-size: 0.95rem;
        }
        
        button:hover {
            background: #1f3f2a;
        }
        
        .boards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .board-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            border-top: 4px solid #2d5a3d;
            page-break-inside: avoid;
        }
        
        .board-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 8px;
        }
        
        .board-number {
            font-size: 1.3rem;
            font-weight: bold;
            color: #2d5a3d;
        }
        
        .board-metadata {
            display: flex;
            gap: 15px;
            font-size: 0.85rem;
            align-items: center;
        }
        
        .meta-item {
            background: #f5f5f5;
            padding: 4px 8px;
            border-radius: 3px;
        }
        
        .meta-label {
            font-weight: bold;
            color: #666;
        }
        
        .board-content {
            display: flex;
            gap: 15px;
            align-items: flex-start;
        }
        
        .bbo-viewer {
            flex: 1;
            min-width: 0;
        }
        
        .bbo-frame {
            width: 100%;
            height: 320px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .dd-table-compact {
            flex: 0 0 auto;
            background: linear-gradient(135deg, #2d5a3d 0%, #1f3f2a 100%);
            padding: 10px;
            border-radius: 6px;
            min-width: 200px;
        }
        
        .dd-title {
            color: white;
            font-size: 0.85rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 8px;
            border-bottom: 2px solid rgba(255,255,255,0.3);
            padding-bottom: 6px;
        }
        
        .dd-table-compact table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .dd-table-compact th {
            background: #2d5a3d;
            color: white;
            padding: 5px 4px;
            text-align: center;
            font-size: 0.8rem;
            font-weight: bold;
            border: 1px solid #1f3f2a;
        }
        
        .dd-table-compact td {
            padding: 5px 4px;
            text-align: center;
            font-size: 0.8rem;
            border: 1px solid #ddd;
            font-weight: bold;
        }
        
        .suit-name {
            background: #f9f9f9;
            font-weight: bold;
            text-align: left;
            padding-left: 6px !important;
        }
        
        /* Suit colors */
        .suit-‚ô£, .suit-C {
            color: #000;
        }
        .suit-‚ô¶, .suit-D {
            color: #dc143c;
        }
        .suit-‚ô•, .suit-H {
            color: #dc143c;
        }
        .suit-‚ô†, .suit-S {
            color: #000;
        }
        .suit-NT {
            color: #2d5a3d;
        }
        
        /* Making contracts highlighted */
        .making {
            background: #c8e6c9 !important;
            color: #1b5e20 !important;
        }
        
        .not-making {
            background: #fff3e0 !important;
            color: #e65100 !important;
        }
        
        .results-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e0e0e0;
            font-size: 0.85rem;
        }
        
        .results-section h4 {
            color: #2d5a3d;
            margin-bottom: 6px;
            font-size: 0.9rem;
        }
        
        .results-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            background: #f9f9f9;
            padding: 8px;
            border-radius: 4px;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .result-item:last-child {
            border-bottom: none;
        }
        
        @media (max-width: 1024px) {
            .boards-grid {
                grid-template-columns: 1fr;
            }
            
            .board-content {
                flex-direction: column;
            }
            
            .dd-table-compact {
                min-width: 100%;
            }
        }
        
        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .controls, .header {
                display: none;
            }
            
            .boards-grid {
                gap: 10px;
                page-break-inside: avoid;
            }
            
            .board-card {
                page-break-inside: avoid;
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }
        
        .loading {
            text-align: center;
            color: white;
            font-size: 1.2rem;
            padding: 20px;
        }
        
        .error {
            background: #fee;
            color: #c00;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
            border-left: 4px solid #c00;
        }
        
        .stats {
            text-align: center;
            color: white;
            margin-top: 20px;
            font-size: 0.95rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ô† Bridge Tournament Hands ‚ô†</h1>
            <p id="tournamentInfo">All hands with Double Dummy Analysis</p>
        </div>

        <div class="controls">
            <button onclick="window.print()">üñ®Ô∏è Print Tournament</button>
            <button onclick="toggleCompact()">Compact View</button>
        </div>

        <div id="loading" class="loading" style="display:none;">Loading tournament data...</div>
        <div id="error" class="error" style="display:none;"></div>

        <div class="boards-grid" id="boardsGrid"></div>

        <div class="stats" id="stats"></div>
    </div>

    <script>
        let allHands = [];
        let boardResults = {};

        async function loadHands() {
            document.getElementById('loading').style.display = 'block';
            try {
                const response = await fetch('/api/hands');
                if (!response.ok) throw new Error('Failed to load hands');
                const handsObj = await response.json();
                allHands = Object.entries(handsObj).map(([id, hand]) => ({ id, ...hand }));
                
                // Try to load results for each board
                await loadBoardResults();
                
                renderAllBoards();
                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                document.getElementById('error').textContent = 'Error: ' + error.message;
                document.getElementById('error').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function loadBoardResults() {
            for (let hand of allHands) {
                try {
                    const filename = `board${hand.id}_results.json`;
                    const response = await fetch(`/${filename}`);
                    if (response.ok) {
                        boardResults[hand.id] = await response.json();
                    }
                } catch (e) {
                    // Silently skip if no results file
                }
            }
        }

        function generateLIN(hand) {
            const dealerMap = {'N':1,'E':2,'S':3,'W':4};
            const vulnMap = {'None':0,'NS':1,'EW':2,'Both':3};
            const dealer = dealerMap[hand.dealer] || 1;
            const vuln = vulnMap[hand.vulnerability] || 0;
            return `qx|o1|md|${dealer}${hand.N},${hand.E},${hand.S}|rh||ah|Board ${hand.id}|sv|${vuln}|pg||`;
        }

        function createDDTable(hand) {
            if (!hand.dd_analysis) {
                return '<table><tr><td style="text-align:center;color:#999;">No DD data</td></tr></table>';
            }

            const dd = hand.dd_analysis;
            const players = ['N', 'S', 'E', 'W'];
            const suits = [
                { symbol: '‚ô£', key: 'C', name: 'Clubs' },
                { symbol: '‚ô¶', key: 'D', name: 'Diamonds' },
                { symbol: '‚ô•', key: 'H', name: 'Hearts' },
                { symbol: '‚ô†', key: 'S', name: 'Spades' },
                { symbol: 'NT', key: 'NT', name: 'No Trump' }
            ];

            let html = '<table>';
            
            // Header with players
            html += '<tr>';
            html += '<th style="text-align: left; width: 35px;">Suit</th>';
            players.forEach(p => {
                html += `<th>${p}</th>`;
            });
            html += '</tr>';
            
            // Suit rows
            suits.forEach(suit => {
                html += '<tr>';
                html += `<td class="suit-name suit-${suit.key}">${suit.symbol}</td>`;
                
                players.forEach(player => {
                    const key = suit.key + player;
                    const value = dd[key] || '-';
                    const isMaking = parseInt(value) >= 10;
                    const className = value !== '-' ? (isMaking ? 'making' : 'not-making') : '';
                    html += `<td class="${className}">${value}</td>`;
                });
                
                html += '</tr>';
            });
            
            html += '</table>';
            return html;
        }

        function renderAllBoards() {
            const grid = document.getElementById('boardsGrid');
            grid.innerHTML = '';

            allHands.forEach((hand, index) => {
                const card = document.createElement('div');
                card.className = 'board-card';
                
                // Header
                let headerHTML = `
                    <div class="board-header">
                        <div class="board-number">Board ${hand.id}</div>
                        <div class="board-metadata">
                            <span class="meta-item"><span class="meta-label">Dealer:</span> ${hand.dealer || '-'}</span>
                            <span class="meta-item"><span class="meta-label">Vuln:</span> ${hand.vulnerability || '-'}</span>
                        </div>
                    </div>
                `;

                // Content (BBO viewer + DD table)
                const lin = generateLIN(hand);
                const encoded = encodeURIComponent(lin);
                let contentHTML = `
                    <div class="board-content">
                        <div class="bbo-viewer">
                            <iframe class="bbo-frame" src="https://www.bridgebase.com/tools/handviewer.html?lin=${encoded}" style="border: 1px solid #ddd; border-radius: 4px;"></iframe>
                        </div>
                        <div class="dd-table-compact">
                            <div class="dd-title">Double Dummy</div>
                            ${createDDTable(hand)}
                        </div>
                    </div>
                `;

                // Results section (if available)
                let resultsHTML = '';
                if (boardResults[hand.id]) {
                    const results = boardResults[hand.id];
                    if (results.pairs && results.pairs.length > 0) {
                        resultsHTML = `
                            <div class="results-section">
                                <h4>Results</h4>
                                <div class="results-list">
                        `;
                        results.pairs.forEach(pair => {
                            const displayStr = `${pair.pair}: ${pair.direction} ${pair.result}`;
                            resultsHTML += `<div class="result-item"><span>${displayStr}</span><span>${pair.score}</span></div>`;
                        });
                        resultsHTML += `</div></div>`;
                    }
                }

                card.innerHTML = headerHTML + contentHTML + resultsHTML;
                grid.appendChild(card);
            });

            // Update stats
            document.getElementById('stats').textContent = `Total: ${allHands.length} boards`;
        }

        function toggleCompact() {
            document.body.style.fontSize = document.body.style.fontSize === '12px' ? '14px' : '12px';
        }

        // Load data on page load
        loadHands();
    </script>
</body>
</html>
