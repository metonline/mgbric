<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="expires" content="0">
    <title>Turnuva Elleri - Tournament Hands</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }
        
        .controls {
            text-align: center;
            margin-bottom: 20px;
        }
        
        button {
            padding: 8px 15px;
            background: #333;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        button:hover {
            background: #555;
        }
        
        .boards-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
            max-width: 100%;
        }
        
        .board-card {
            background: white;
            padding: 12px;
            border: 1px solid #ccc;
            page-break-inside: avoid;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .board-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 4px 0;
            border-bottom: 1px solid #ccc;
            font-size: 0.9rem;
        }
        
        .board-header-left {
            flex: 1;
            text-align: left;
        }
        
        .board-header-center {
            flex: 1;
            text-align: center;
            font-size: 1.1rem;
            font-weight: bold;
        }
        
        .board-header-right {
            flex: 1;
            text-align: right;
        }
        
        .board-content {
            display: grid;
            grid-template-columns: 70px 1fr;
            gap: 8px;
            flex: 1;
            align-items: flex-start;
        }
        
        .board-vuln-left {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
        }
        
        .bbo-viewer {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
        }
        
        /* Vulnerability indicator removed */
        
        .bbo-viewer.vuln-none {
            background: #e8f5e9;
            border: 2px solid #4caf50;
        }
        
        .bbo-viewer.vuln-ns {
            background: #fff3e0;
            border: 2px solid #ff9800;
        }
        
        .bbo-viewer.vuln-ew {
            background: #e3f2fd;
            border: 2px solid #2196f3;
        }
        
        .bbo-viewer.vuln-both {
            background: #fce4ec;
            border: 2px solid #e91e63;
        }
        
        .bbo-frame {
            width: 100%;
            height: auto;
            aspect-ratio: 4 / 3;
            border: 1px solid #999;
        }
        
        .dd-table-simple {
            width: 100%;
            border: 1px solid #333;
            display: flex;
            justify-content: center;
            padding: 4px;
        }
        
        .dd-table-simple table {
            border-collapse: collapse;
            font-family: Arial, sans-serif;
            width: auto;
        }
        
        .dd-table-simple th {
            background: white;
            border: 1px solid #333;
            padding: 5px 7px;
            text-align: center;
            font-weight: bold;
            font-size: 0.85rem;
        }
        
        .dd-table-simple td {
            border: 1px solid #333;
            padding: 5px 7px;
            text-align: center;
            min-width: 32px;
            font-size: 0.85rem;
            font-weight: bold;
        }
        
        .suit-C { color: #000; font-weight: bold; }
        .suit-D { color: #d00; font-weight: bold; }
        .suit-H { color: #d00; font-weight: bold; }
        .suit-S { color: #000; font-weight: bold; }
        .suit-NT { font-weight: bold; }
        
        .making {
            background: #c8e6c9 !important;
        }
        
        .results-section {
            margin-top: 10px;
            font-size: 0.8rem;
        }
        
        .results-section h4 {
            margin-bottom: 4px;
            font-weight: bold;
        }
        
        @media (max-width: 1280px) {
            .boards-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .boards-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .controls {
                display: none;
            }
            
            .board-card {
                page-break-inside: avoid;
                border: 1px solid #ddd;
            }
        }
        
        .loading, .error, .stats {
            text-align: center;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŒ‰ Turnuva Elleri</h1>

        <div id="loading" class="loading" style="display:none;">Loading tournament data...</div>
        <div id="error" class="error" style="display:none;"></div>

        <div class="boards-grid" id="boardsGrid"></div>

        <div class="stats" id="stats"></div>
    </div>

    <script>
        let allHands = [];
        let boardResults = {};

        function getVulnColor(player, vuln) {
            if (!vuln) return 'vuln-white';
            const v = vuln.toLowerCase().trim();
            
            // Both vulnerable = all red
            if (v === 'both' || v === 'all') return 'vuln-red';
            
            // None vulnerable = all white
            if (v === 'none' || v === '-') return 'vuln-white';
            
            // NS vulnerable: N and S are red, E and W are white
            if (v === 'ns' || v === 'n-s') {
                return (player === 'N' || player === 'S') ? 'vuln-red' : 'vuln-white';
            }
            
            // EW vulnerable: E and W are red, N and S are white
            if (v === 'ew' || v === 'e-w') {
                return (player === 'E' || player === 'W') ? 'vuln-red' : 'vuln-white';
            }
            
            return 'vuln-white';
        }

        function getVulnClass(vuln) {
            if (!vuln) return 'vuln-none';
            const v = vuln.toLowerCase().trim();
            if (v === 'none' || v === '-') return 'vuln-none';
            if (v === 'ns' || v === 'n-s') return 'vuln-ns';
            if (v === 'ew' || v === 'e-w') return 'vuln-ew';
            if (v === 'both' || v === 'all') return 'vuln-both';
            return 'vuln-none';
        }

        async function loadHands() {
            document.getElementById('loading').style.display = 'block';
            try {
                const response = await fetch('/api/hands');
                if (!response.ok) throw new Error('Failed to load hands');
                const handsObj = await response.json();
                allHands = Object.entries(handsObj).map(([id, hand]) => ({ id, ...hand }));
                
                // Try to load results for each board
                await loadBoardResults();
                
                renderAllBoards();
                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                document.getElementById('error').textContent = 'Error: ' + error.message;
                document.getElementById('error').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function loadBoardResults() {
            for (let hand of allHands) {
                try {
                    const filename = `board${hand.id}_results.json`;
                    const response = await fetch(`/${filename}`);
                    if (response.ok) {
                        boardResults[hand.id] = await response.json();
                    }
                } catch (e) {
                    // Silently skip if no results file
                }
            }
        }

        function generateLIN(hand) {
            const dealerMap = {'N':1,'E':2,'S':3,'W':4};
            const vulnMap = {'None':0,'NS':1,'EW':2,'Both':3};
            const dealer = dealerMap[hand.dealer] || 1;
            const vuln = vulnMap[hand.vulnerability] || 0;
            return `qx|o1|md|${dealer}${hand.N},${hand.E},${hand.S}|rh||ah|Board ${hand.id}|sv|${vuln}|pg||`;
        }

        function createDDTable(hand) {
            if (!hand.dd_analysis) {
                return '<div style="text-align:center;color:#999;padding:10px;">No DD data</div>';
            }

            const dd = hand.dd_analysis;
            const players = ['N', 'S', 'E', 'W'];
            const suits = [
                { symbol: 'â™£', key: 'C' },
                { symbol: 'â™¦', key: 'D' },
                { symbol: 'â™¥', key: 'H' },
                { symbol: 'â™ ', key: 'S' },
                { symbol: 'NT', key: 'NT' }
            ];

            let html = '<table>';
            
            // Header
            html += '<tr>';
            html += '<th style="width: 25px;"></th>';
            suits.forEach(suit => {
                html += `<th class="suit-${suit.key}">${suit.symbol}</th>`;
            });
            html += '</tr>';
            
            // Rows
            players.forEach(player => {
                html += '<tr>';
                html += `<td style="font-weight: bold; text-align: center; width: 25px;">${player}</td>`;
                
                suits.forEach(suit => {
                    const key = suit.key + player;
                    const value = dd[key] || '-';
                    const isMaking = parseInt(value) >= 10;
                    const bgColor = (isMaking && value !== '-') ? '#c8e6c9' : 'white';
                    html += `<td style="background:${bgColor};">${value}</td>`;
                });
                
                html += '</tr>';
            });
            
            html += '</table>';
            return html;
        }

        function renderAllBoards() {
            const grid = document.getElementById('boardsGrid');
            grid.innerHTML = '';

            allHands.forEach((hand, index) => {
                const card = document.createElement('div');
                card.className = 'board-card';
                
                const lin = generateLIN(hand);
                const encoded = encodeURIComponent(lin);
                
                let html = `
                    <div class="board-header">
                        <div class="board-header-left">Vuln: ${hand.vulnerability}</div>
                        <div class="board-header-center">Board ${hand.id}</div>
                        <div class="board-header-right">Dealer: ${hand.dealer}</div>
                    </div>
                    <div class="board-content">
                        <div class="bbo-viewer ${getVulnClass(hand.vulnerability)}">
                            <iframe class="bbo-frame" src="https://www.bridgebase.com/tools/handviewer.html?lin=${encoded}"></iframe>
                        </div>
                        <div class="dd-table-simple">
                            ${createDDTable(hand)}
                        </div>
                    </div>
                `;

                card.innerHTML = html;
                grid.appendChild(card);
            });

            document.getElementById('stats').textContent = `Total: ${allHands.length} boards`;
        }

        function toggleCompact() {
            document.body.style.fontSize = document.body.style.fontSize === '12px' ? '14px' : '12px';
        }

        // Load data on page load
        loadHands();
    </script>
</body>
</html>
